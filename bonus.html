<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆæœ¬æœˆï¼‹ä¸Šæœˆï¼‰</title>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--bd:#ddd;--muted:#666;--brand:#4f8cff;--brand2:#7aa2ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;color:#222}
    .container{max-width:1000px;margin:0 auto;padding:16px 16px 100px}
    h1{margin:0 0 8px}.lead{color:var(--muted);margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    input:not([type=checkbox]):not([type=radio]),button,a.btn{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    label span{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .btn{cursor:pointer;background:#f3f4f6;text-align:center;text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#fff;border:none;font-weight:600}
    .btn.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    .btn.danger{background:#fde2e2;border-color:#f5c2c7;color:#842029}
    .actions{display:grid;gap:10px;grid-template-columns:1fr 1fr} @media(min-width:640px){.actions{grid-template-columns:repeat(4,1fr)}}
    .dock{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-top:1px solid var(--bd);padding:10px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(min-width:640px){.dock{grid-template-columns:repeat(4,1fr)}}
    .table{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px;margin-top:12px}
    pre{white-space:pre-wrap}
    .toast-wrap{position:fixed;right:12px;bottom:12px;z-index:9999;display:grid;gap:8px;max-width:80vw}
    .toast{background:rgba(0,0,0,.82);color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);font-size:14px}
    .dbg{position:fixed;left:12px;bottom:12px;background:rgba(255,255,255,.9);border:1px solid var(--bd);padding:8px;border-radius:10px;font-size:12px;box-shadow:0 6px 20px rgba(0,0,0,.1);z-index:9998}
    label.pickline input.pickRec{ width:auto; display:inline-block; vertical-align:middle; margin:0 6px 0 6px; }

    /* Segmented switch */
    .seg{display:inline-grid;grid-auto-flow:column;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;padding:6px;border-radius:999px}
    .seg button{border:none;background:transparent;padding:6px 12px;border-radius:999px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:#4f46e5;color:#fff}

    #btnLoadMonth, #monthSelect, #btnToggleHistory, #btnBackToCurrent { display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
    <p class="lead">è‡ªå‹•è¼‰å…¥ã€Œæœ¬æœˆï¼‹ä¸Šæœˆã€ï½œåº•åƒ¹è‡ªå‹•å¸¶å…¥ï¼ˆå¯æ‰‹å‹•è¦†å¯«ï¼‰ï½œå¯è¤‡è£½/åˆªé™¤ç´€éŒ„</p>

    <div style="display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:10px;">
      <div class="seg" role="tablist" aria-label="é¡¯ç¤ºæœˆä»½ç¯©é¸">
        <button id="viewPrev" role="tab" aria-pressed="false" title="åªé¡¯ç¤ºä¸Šæœˆ">åƒ…ä¸Šæœˆ</button>
        <button id="viewBoth" role="tab" aria-pressed="true" title="åŒæ™‚é¡¯ç¤ºæœ¬æœˆ+ä¸Šæœˆ">åˆä½µ</button>
        <button id="viewCurr" role="tab" aria-pressed="false" title="åªé¡¯ç¤ºæœ¬æœˆ">åƒ…æœ¬æœˆ</button>
      </div>
      <div id="sumBar" style="font-weight:600;color:#374151;">
        æœ¬æœˆï¼š<span id="sumCurrent">0</span> å…ƒï½œä¸Šæœˆï¼š<span id="sumPrev">0</span> å…ƒ
      </div>
    </div>

    <section class="card">
      <p>æ¯å…¬æ–¤åº•åƒ¹ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š<span id="basePriceDisplay" class="em">-</span> å…ƒ</p>
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input id="salesName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>éŠ·å”®å“å</span><input id="productName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input id="actualWeight" type="number" placeholder="0"/></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input id="actualPrice" type="number" placeholder="0"/></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input id="costPerKg" type="number" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œå¯æ‰‹å‹•ä¿®æ”¹"/></label>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <label><input type="checkbox" id="homeDelivery"/> å®…é…ï¼ˆæ‰£250å…ƒï¼‰</label>
        <label><input type="checkbox" id="selfDelivery"/> è‡ªè¡Œé…é€ï¼ˆæ¯å…¬æ–¤åŠ 3å…ƒï¼‰</label>
        <label><input type="checkbox" id="companyDriver"/> å…¬å¸å¸æ©Ÿï¼ˆæ¯å…¬æ–¤æ‰£3å…ƒï¼‰</label>
        <label><input type="checkbox" id="kaohsiungLocal"/> é«˜é›„å¸‚å€å…¬å¸è»Šï¼ˆæ•´ç­† +5 å…ƒï¼‰</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—çé‡‘</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <a class="btn primary" href="./index.html">è¿”å›ä¸»é </a>
        <button class="btn danger" id="btnDelPicked">åˆªé™¤é¸å–ç´€éŒ„</button>
      </div>

      <p class="em">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>

      <div class="table">
        <strong>ç´€éŒ„åˆ—è¡¨</strong>
        <pre id="historyDisplay"></pre>
        <div id="monthlyButtons" style="margin-top:8px;">
          <button class="btn" id="btnCopyPicked">è¤‡è£½é¸å–ç´€éŒ„</button>
        </div>
      </div>
    </section>
  </div>

  <nav class="dock">
    <button class="btn primary" id="dockCalc">è¨ˆç®—</button>
    <button class="btn ok" id="dockExport">åŒ¯å‡º CSV</button>
    <a class="btn primary" href="./index.html">ä¸»é </a>
    <button class="btn danger" id="dockDelPicked">åˆªé™¤é¸å–ç´€éŒ„</button>
  </nav>

  <div id="toast-wrap" class="toast-wrap" hidden></div>
  <div class="dbg" id="dbgPanel">UID: â€”<br>Profile: default<br>æœ¬åœ°ç­†æ•¸: 0</div>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    // ===== Firestore base =====
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    const db = firebase.firestore();
    try { db.enablePersistence({synchronizeTabs:true}); } catch(e){ console.warn(e); }
    firebase.auth().signInAnonymously().catch(console.warn);
    const PROFILE_ID = "default";

    // ===== helper =====
    function toast(msg, ms=2200){
      const wrap = document.getElementById('toast-wrap'); wrap.hidden=false;
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .25s'; setTimeout(()=>t.remove(), 300); }, ms);
    }
    const $ = id=>document.getElementById(id);
    const num = v=>{const n=parseFloat(v);return isFinite(n)?n:null;};
    const ymKey = (d=new Date()) => d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    const ymFromDateStr = (s)=>{
      try{ const dt=new Date(s); if(!isNaN(dt)) return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0"); }catch(e){}
      const m=(s||"").match(/(\d{4})[\/\-](\d{1,2})/);
      if(m) return m[1]+"-"+String(parseInt(m[2],10)).padStart(2,"0");
      const now=new Date(); return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
    };

    // ===== base price =====
    function pickBase(){
      const fromInput = num($("costPerKg") && $("costPerKg").value);
      if (fromInput !== null) return fromInput;
      const urlBp = num(new URLSearchParams(location.search).get("bp"));
      if (urlBp !== null) return urlBp;
      const stored = num(localStorage.getItem("basePrice"));
      if (stored !== null) return stored;
      return null;
    }
    async function maybeFetchBaseFromCloud(){
      const el = $("costPerKg");
      const has = el && el.value.trim() !== "";
      const urlBp = new URLSearchParams(location.search).get("bp");
      const localBp = localStorage.getItem("basePrice");
      if (has || (urlBp && !isNaN(parseFloat(urlBp))) || (localBp && !isNaN(parseFloat(localBp)))) return;
      try{
        const snap = await db.collection("profiles").doc(PROFILE_ID).collection("settings").doc("base").get();
        if (snap.exists && isFinite(snap.data().basePrice)){
          const v = Math.round(Number(snap.data().basePrice));
          if (el && !el.value) el.value = String(v);
          const disp = $("basePriceDisplay"); if (disp) disp.innerText = String(v);
          localStorage.setItem("basePrice", String(snap.data().basePrice));
        }
      }catch(e){ console.warn(e); }
    }
    function refreshBaseDisplay(){
      const disp = $("basePriceDisplay");
      const v = pickBase();
      disp.innerText = v !== null ? String(Math.round(v)) : "-";
    }

    // ===== dedup & state =====
    function keyOf(r){
      // Primary: Firestore doc id; Fallback: createdAt+name+price+weight+date
      if (r && r._id) return "id:"+r._id;
      return "ts:"+String(r.createdAt||"")+"|"+(r.name||"")+"|"+(r.price||"")+"|"+(r.weight||"")+"|"+(r.date||"");
    }
    function dedup(list){
      const seen = new Set();
      const out = [];
      for (const r of list||[]){
        const k = keyOf(r);
        if (seen.has(k)) continue;
        seen.add(k);
        out.push(r);
      }
      return out;
    }

    window.__ALL_RECORDS__ = []; // åˆä½µï¼ˆå»é‡ï¼‰
    window.__VIEW_MODE__ = "both"; // both | current | prev
    window.__selSet = new Set();   // å…¨åŸŸç´¢å¼•é›†åˆ

    function setViewMode(mode){
      window.__VIEW_MODE__ = mode;
      ["viewPrev","viewBoth","viewCurr"].forEach(id => $(id).setAttribute("aria-pressed","false"));
      if (mode === "prev") $("viewPrev").setAttribute("aria-pressed","true");
      else if (mode === "current") $("viewCurr").setAttribute("aria-pressed","true");
      else $("viewBoth").setAttribute("aria-pressed","true");
      renderCurrent(window.__ALL_RECORDS__);
    }

    // ===== render =====
    function renderCurrent(allArr){
      const now=new Date();
      const ymNow = ymKey(now);
      const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const prevYm = ymKey(prev);

      const arr = Array.isArray(allArr) ? dedup(allArr.slice()) : [];

      // sums
      const sumCurr = arr.filter(r=> ymFromDateStr(r.date)===ymNow).reduce((s,r)=> s + (Number(r.bonus)||0), 0);
      const sumPrev = arr.filter(r=> ymFromDateStr(r.date)===prevYm).reduce((s,r)=> s + (Number(r.bonus)||0), 0);
      $("sumCurrent").innerText = Math.round(sumCurr);
      $("sumPrev").innerText = Math.round(sumPrev);

      // filter by mode
      let list = arr;
      if (window.__VIEW_MODE__ === "current"){
        list = arr.filter(r=> ymFromDateStr(r.date)===ymNow);
      } else if (window.__VIEW_MODE__ === "prev"){
        list = arr.filter(r=> ymFromDateStr(r.date)===prevYm);
      }

      let outTitle = "ğŸ“˜ ";
      outTitle += window.__VIEW_MODE__==="both" ? "æœ¬æœˆï¼‹ä¸Šæœˆç´€éŒ„ï¼š" : (window.__VIEW_MODE__==="current"?"æœ¬æœˆç´€éŒ„ï¼š":"ä¸Šæœˆç´€éŒ„ï¼š");

      let out = outTitle;
      if(!list.length) out += "<br>ï¼ˆå°šç„¡ï¼‰";
      else {
        out += list.map((r,i)=>{
          const name = (r.name||"");
          const prod = (r.product||"");
          const dateOnly = (function(){
            try { const dt = new Date(r.date); if (!isNaN(dt)) return dt.toLocaleDateString(); } catch(e){}
            const s = (r.date||""); const sp = s.split(" "); return sp[0] || s;
          })();
          const gIdx = arr.findIndex(o=> keyOf(o)===keyOf(r)); // map visible -> global
          const checked = window.__selSet.has(gIdx) ? "checked" : "";
          const line = ` <label class="pickline"> #${i+1} <input type="checkbox" class="pickRec" data-global-idx="${gIdx}" ${checked}> ${dateOnly}  ${name}  ${prod} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ</label>`;
          return "<br>" + line;
        }).join("");
      }
      $("historyDisplay").innerHTML = out;

      // bind selection
      document.querySelectorAll('#historyDisplay input.pickRec').forEach(ch=>{
        ch.addEventListener('change', ()=>{
          const gIdx = parseInt(ch.getAttribute('data-global-idx'),10);
          if (ch.checked) window.__selSet.add(gIdx); else window.__selSet.delete(gIdx);
        });
      });
    }

    async function pushLocalIfCloudEmpty(){
      const all = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      const ym = ymKey();
      const arr = all.filter(r=> ymFromDateStr(r.date)===ym);
      if (!arr.length) return false;
      try{
        const q = await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records").limit(1).get();
        if (!q.empty) return false;
        let t0=Date.now();
        for(let i=0;i<arr.length;i++){
          const r = arr[i];
          await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records")
            .add(Object.assign({}, r, { createdAt: (typeof r.createdAt==='number'? r.createdAt : (t0+i)) }));
        }
        await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).set({month:ym,updatedAt:Date.now()},{merge:true});
        toast("é›²ç«¯ç„¡è³‡æ–™ï¼ˆæœ¬æœˆï¼‰ï¼Œå·²å¾æœ¬åœ°ä¸Šå‚³ "+arr.length+" ç­†");
        return true;
      }catch(e){ console.warn(e); return false; }
    }

    function exportCSV(){
      const arr = dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
      let csv = "æ¥­å‹™å§“å,éŠ·å”®å“å,æ•¸é‡(kg),æˆäº¤å–®åƒ¹,ç¸½é‡‘é¡,çé‡‘,æ—¥æœŸ\n";
      arr.forEach(r=> csv += `${r.name||""},${r.product||""},${r.weight},${r.price},${r.total},${r.bonus},${r.date}\n`);
      const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="æ¥­å‹™çé‡‘å ±è¡¨.csv"; a.click();
    }

    async function deletePicked(){
      const all = dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
      if (!window.__selSet || window.__selSet.size===0) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„ç´€éŒ„");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é¸å–çš„ "+window.__selSet.size+" ç­†ï¼Ÿ")) return;
      // Build keys of selected
      const keys = Array.from(window.__selSet).map(i=> keyOf(all[i]));
      // Delete from Firestore by month / id / createdAt
      for (const i of Array.from(window.__selSet).sort((a,b)=>b-a)){
        const r = all[i]; if (!r) continue;
        const ym = ymFromDateStr(r.date||"");
        const col = db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records");
        try{
          if (r._id){ await col.doc(r._id).delete(); }
          else if (typeof r.createdAt === "number"){
            const q = await col.where("createdAt","==", r.createdAt).limit(1).get();
            if (!q.empty) await q.docs[0].ref.delete();
          }
        }catch(e){ console.warn(e); }
        all.splice(i,1);
      }
      localStorage.setItem("monthlyBonus", JSON.stringify(all));
      window.__ALL_RECORDS__ = all.slice();
      window.__selSet.clear();
      renderCurrent(all);
      toast("å·²åˆªé™¤é¸å–ç´€éŒ„");
    }

    function calculateBonus(){
      const actual = num($("actualPrice").value);
      const weight = num($("actualWeight").value);
      if (actual === null || weight === null || weight<=0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤å–®åƒ¹èˆ‡é‡é‡");
      const cost = pickBase(); if (cost === null) return alert("è«‹å…ˆè¼¸å…¥ã€æˆæœ¬(å…ƒ/kg)ã€æˆ–å›ä¸»é è¨ˆç®—åº•åƒ¹");

      const deduct = $("homeDelivery").checked ? 250 : 0;
      const addSelf = $("selfDelivery").checked ? weight * 3 : 0;
      const deductDriver = $("companyDriver").checked ? weight * 3 : 0;
      const addKHH = $("kaohsiungLocal").checked ? 5 : 0;
      const diff = actual - cost;
      const bonus = diff > 0 ? diff * weight - deduct - deductDriver + addSelf + addKHH : 0;
      $("bonusResult").innerText = String(Math.round(bonus));

      const __defDate = new Date().toLocaleString();
      const __inDate = prompt("è«‹è¼¸å…¥æ—¥æœŸï¼ˆå¯è‡ªè¡Œç·¨è¼¯ï¼‰", __defDate);
      const __dateStr = (__inDate && __inDate.trim()) ? __inDate.trim() : __defDate;
      const rec = {
        date: __dateStr,
        name: $("salesName").value.trim(),
        product: $("productName").value.trim(),
        weight, price: actual, total: actual*weight, bonus: Math.round(bonus),
        createdAt: Date.now()
      };
      const arr = dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
      arr.push(rec); localStorage.setItem("monthlyBonus", JSON.stringify(arr));
      window.__ALL_RECORDS__ = arr.slice();
      renderCurrent(arr);

      const ym = ymFromDateStr(__dateStr);
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records").add(rec).catch(console.warn);
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).set({month:ym,updatedAt:Date.now()},{merge:true});
    }

    async function initialPull(){
      const now = new Date();
      const ymNow = ymKey(now);
      const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const prevYm = ymKey(prev);

      const arr = [];

      const snapNow = await db.collection("profiles").doc(PROFILE_ID)
        .collection("months").doc(ymNow).collection("records")
        .orderBy("createdAt","asc").get();
      snapNow.forEach(doc=> arr.push(Object.assign({_id:doc.id}, doc.data())));

      const snapPrev = await db.collection("profiles").doc(PROFILE_ID")
        .collection("months").doc(prevYm).collection("records")
        .orderBy("createdAt","asc").get();
      snapPrev.forEach(doc=> arr.push(Object.assign({_id:doc.id}, doc.data())));

      const de = dedup(arr);
      localStorage.setItem("monthlyBonus", JSON.stringify(de));
      window.__ALL_RECORDS__ = de.slice();
      renderCurrent(de);
    }

    firebase.auth().onAuthStateChanged(async u=>{
      $("dbgPanel").innerHTML = `UID: ${u?u.uid:"ï¼ˆæœªç™»å…¥ï¼‰"}<br>Profile: default<br>æœ¬åœ°ç­†æ•¸: ${(JSON.parse(localStorage.getItem('monthlyBonus')||'[]').length)}`;
      if(!u || window._startedRealtimeOnce) return;
      window._startedRealtimeOnce = true;

      (function(){
        const el=$("costPerKg"); if(el && !el.value){ const v=pickBase(); if(v!==null) el.value=String(Math.round(v)); }
        refreshBaseDisplay();
      })();
      maybeFetchBaseFromCloud();

      await pushLocalIfCloudEmpty();
      await initialPull();

      const now = new Date();
      const ymNow = ymKey(now);
      const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const prevYm = ymKey(prev);

      // æœ¬æœˆç›£è½
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ymNow).collection("records")
        .orderBy("createdAt","asc").onSnapshot(snap=>{
          const all = dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
          // å…ˆåˆªé™¤èˆŠçš„æœ¬æœˆï¼Œå†åŠ å…¥æ–°çš„æœ¬æœˆ
          const others = all.filter(r => ymFromDateStr(r.date) !== ymNow);
          const cur = []; snap.forEach(doc=> cur.push(Object.assign({_id:doc.id}, doc.data())));
          const merged = dedup(others.concat(cur));
          localStorage.setItem("monthlyBonus", JSON.stringify(merged));
          window.__ALL_RECORDS__ = merged.slice();
          renderCurrent(merged);
        });

      // ä¸Šæœˆç›£è½
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(prevYm).collection("records")
        .orderBy("createdAt","asc").onSnapshot(snap=>{
          const all = dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
          const others = all.filter(r => ymFromDateStr(r.date) !== prevYm);
          const prevArr = []; snap.forEach(doc=> prevArr.push(Object.assign({_id:doc.id}, doc.data())));
          const merged = dedup(others.concat(prevArr));
          localStorage.setItem("monthlyBonus", JSON.stringify(merged));
          window.__ALL_RECORDS__ = merged.slice();
          renderCurrent(merged);
        });

      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ymNow)
        .set({month:ymNow,updatedAt:Date.now()},{merge:true});
    });

    document.addEventListener("DOMContentLoaded", ()=>{
      ["btnCalc","dockCalc"].forEach(id=> $(id).onclick = calculateBonus);
      ["btnExport","dockExport"].forEach(id=> $(id).onclick = exportCSV);
      ["btnDelPicked","dockDelPicked"].forEach(id=> $(id).onclick = deletePicked);
      $("costPerKg")?.addEventListener("input", refreshBaseDisplay);

      // åˆ‡æ›è¦–åœ–
      $("viewPrev").addEventListener("click", ()=> setViewMode("prev"));
      $("viewBoth").addEventListener("click", ()=> setViewMode("both"));
      $("viewCurr").addEventListener("click", ()=> setViewMode("current"));

      // è¤‡è£½é¸å–
      $("btnCopyPicked").addEventListener("click", async ()=>{
        const all = dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
        if (!window.__selSet || window.__selSet.size===0){ alert("è«‹å…ˆå‹¾é¸è¦è¤‡è£½çš„ç´€éŒ„"); return; }
        const defDate = new Date().toLocaleString();
        const inDate = prompt("è¤‡è£½é¸å–çš„ç´€éŒ„ï¼šè¼¸å…¥æ–°æ—¥æœŸï¼ˆå¥—ç”¨æ–¼æ‰€æœ‰å‹¾é¸ï¼‰", defDate);
        if (inDate===null) return;
        const dateStr = (inDate && inDate.trim()) ? inDate.trim() : defDate;
        const ids = Array.from(window.__selSet).sort((a,b)=>a-b);
        ids.forEach((gIdx,k)=>{
          const r = all[gIdx]; if (!r) return;
          const rec2 = Object.assign({}, r, { date: dateStr, createdAt: Date.now()+k, _id: undefined });
          all.push(rec2);
          const ym = ymFromDateStr(dateStr);
          db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records").add(rec2);
          db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).set({month:ym,updatedAt:Date.now()},{merge:true});
        });
        const merged = dedup(all);
        localStorage.setItem("monthlyBonus", JSON.stringify(merged));
        window.__ALL_RECORDS__ = merged.slice();
        window.__selSet.clear();
        renderCurrent(merged);
        toast("å·²è¤‡è£½ "+ids.length+" ç­†");
      });

      // å¿«æ·éµï¼šCtrl/âŒ˜+1 åƒ…ä¸Šæœˆã€+2 åˆä½µã€+3 åƒ…æœ¬æœˆ
      document.addEventListener("keydown", (e)=>{
        const k=(e.key||'').toLowerCase();
        if ((e.ctrlKey||e.metaKey) && k==='1'){ e.preventDefault(); setViewMode("prev"); }
        if ((e.ctrlKey||e.metaKey) && k==='2'){ e.preventDefault(); setViewMode("both"); }
        if ((e.ctrlKey||e.metaKey) && k==='3'){ e.preventDefault(); setViewMode("current"); }
      });

      renderCurrent(dedup(JSON.parse(localStorage.getItem("monthlyBonus") || "[]")));
      refreshBaseDisplay();
      maybeFetchBaseFromCloud();
    });
  </script>
</body>
</html>
