<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆRWD æ·ºè‰²ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --muted:#555;
      --text:#222;
      --brand:#4f8cff;
      --brand-2:#7aa2ff;
      --danger:#d9534f;
      --ok:#32d296;
      --bd:#ccc;
      --radius:12px;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container{ max-width:1000px; margin:0 auto; padding: max(env(safe-area-inset-top), 16px) 16px calc(88px + env(safe-area-inset-bottom)); }
    h1{ font-size: clamp(20px, 3.5vw, 28px); margin:0 0 12px; }
    p.lead{ color:var(--muted); margin:0 0 18px; }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:var(--radius); padding:16px; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:640px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width:960px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    label span{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, button, a.btn{ width:100%; padding:10px; border-radius:8px; border:1px solid var(--bd); background:#fff; color:#222; }
    .btn{ cursor:pointer; border:1px solid var(--bd); background:#f0f0f0; text-decoration:none; display:block; text-align:center; }
    .btn.primary{ background:linear-gradient(180deg, var(--brand-2), var(--brand)); border:none; color:#fff; font-weight:600; }
    .btn.ok{ background:#d4edda; border-color:#c3e6cb; color:#155724; }
    .btn.danger{ background:#f8d7da; border-color:#f5c6cb; color:#a94442; }
    .actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    @media (min-width:640px){ .actions{ grid-template-columns: repeat(4, 1fr); } }
    .highlight{ font-weight:700; color:#b00020; }
    .notice{ font-size:12px; color:var(--muted); }
    .table{ background:#fff; border:1px solid var(--bd); border-radius:8px; padding:12px; margin-top:12px; }
    .dock{
      position:fixed; left:0; right:0; bottom:0; backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.9); border-top:1px solid var(--bd);
      padding:10px 12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    @media (min-width:640px){ .dock{ grid-template-columns: repeat(4, 1fr); } }
    pre{ white-space: pre-wrap; background:#fafafa; border:1px solid var(--bd); border-radius:8px; padding:10px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
      <p class="lead">è®€å–ä¸»é åº•åƒ¹ï¼ˆlocalStorageï¼‰ï½œæ¯ç­†çé‡‘è¨˜éŒ„æœ¬æœˆï¼Œè·¨æœˆè‡ªå‹•æ­¸æª”</p>
    </header>

    <section class="card">
      <p>æ¯å…¬æ–¤åº•åƒ¹ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š<span id="basePriceDisplay" class="highlight">-</span> å…ƒ</p>
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input type="text" id="salesName" placeholder="è«‹è¼¸å…¥æ¥­å‹™å§“å" /></label>
        <label><span>éŠ·å”®å“å</span><input type="text" id="productName" placeholder="è«‹è¼¸å…¥éŠ·å”®å“å" /></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input type="number" id="actualWeight" placeholder="0" /></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input type="number" id="actualPrice" placeholder="0" /></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input type="number" id="costPerKg" placeholder="è‡ªå‹•å¸¶å…¥åº•åƒ¹ï¼Œå¯æ‰‹å‹•ä¿®æ”¹" /></label>
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
        <label><input type="checkbox" id="homeDelivery" /> å®…é…ï¼ˆæ‰£250å…ƒï¼‰</label>
        <label><input type="checkbox" id="selfDelivery" /> è‡ªè¡Œé…é€ï¼ˆæ¯å…¬æ–¤åŠ 3å…ƒï¼‰</label>
        <label><input type="checkbox" id="companyDriver" /> å…¬å¸å¸æ©Ÿï¼ˆæ¯å…¬æ–¤æ‰£3å…ƒï¼‰</label>
        <label><input type="checkbox" id="kaohsiungLocal" /> é«˜é›„å¸‚å€å…¬å¸è»Šï¼ˆåŠ 5å…ƒï¼‰</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—çé‡‘</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <a class="btn" id="btnHome" href="./index.html">è¿”å›ä¸»é </a>
        <button class="btn danger" id="btnClearOne">æ¸…é™¤ä¸Šä¸€ç­†</button>
      </div>

      <p class="highlight">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>
      <p>æœ¬æœˆç´¯ç©çé‡‘ï¼š<span id="totalBonus">0</span> å…ƒ</span></p>
      <div class="table">
        <strong>ç´€éŒ„</strong>
        <pre id="historyDisplay"></pre>
      </div>
      <p class="notice">æç¤ºï¼šæ¯åˆ°æ–°æœˆä»½æœƒè‡ªå‹•å°‡ä¸Šæœˆç´€éŒ„ç§»å…¥æ­·å²å€ã€‚</p>
    </section>
  </div>

  <nav class="dock">
    <button class="btn primary" id="dockCalc">è¨ˆç®—</button>
    <button class="btn ok" id="dockExport">åŒ¯å‡º CSV</button>
    <a class="btn" id="dockHome" href="./index.html">ä¸»é </a>
    <button class="btn danger" id="dockClearOne">æ¸…é™¤ä¸Šä¸€ç­†</button>
  </nav>

  
  <script>
    // ---- Utilities ----
    const $ = (id)=> document.getElementById(id);
    const num = (v)=> { const n = parseFloat(v); return isFinite(n) ? n : null; };

    function getBaseFromPriority(){
      const fromInput = num($("costPerKg")?.value);
      if (fromInput !== null) return fromInput;
      const urlBp = num(new URLSearchParams(location.search).get("bp"));
      if (urlBp !== null) return urlBp;
      const stored = num(localStorage.getItem("basePrice"));
      if (stored !== null) return stored;
      return null;
    }

    function prefillCost(){
      const el = $("costPerKg");
      if (!el || el.value.trim() !== "") return;
      const v = getBaseFromPriority();
      if (v !== null) el.value = String(Math.round(v));
    }

    function updateBaseDisplay(){
      const el = $("basePriceDisplay");
      const v = getBaseFromPriority();
      el.innerText = v !== null ? String(Math.round(v)) : "-";
    }

    function monthKey(d = new Date()){
      return d.getFullYear() + "-" + String(d.getMonth()+1);
    }

    function loadMonthly(){
      return JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
    }
    function saveMonthly(arr){
      localStorage.setItem("monthlyBonus", JSON.stringify(arr||[]));
    }

    function handleMonthRollover(){
      const nowKey = monthKey();
      const last = localStorage.getItem("bonusMonth");
      if (last && last !== nowKey){
        const history = JSON.parse(localStorage.getItem("bonusHistory") || "[]");
        const current = loadMonthly();
        history.push({ month: last, data: current });
        localStorage.setItem("bonusHistory", JSON.stringify(history));
        saveMonthly([]);
      }
      localStorage.setItem("bonusMonth", nowKey);
    }

    function showHistory(){
      const current = loadMonthly();
      const history = JSON.parse(localStorage.getItem("bonusHistory") || "[]");
      let out = "ğŸ“˜ æœ¬æœˆç´€éŒ„ï¼š\n";
      if (current.length === 0) out += "ï¼ˆå°šç„¡ï¼‰\n";
      else current.forEach(r => {
        out += `  ğŸ•’ ${r.date} - ${(r.name||"")} éŠ·å”® ${(r.product||"")} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ\n`;
      });
      if (history.length){
        out += "\nğŸ“š æ­·å²ç´€éŒ„ï¼š\n";
        history.forEach(entry => {
          out += `ğŸ“… ${entry.month}\n`;
          entry.data.forEach(r => {
            out += `  ğŸ•’ ${r.date} - ${(r.name||"")} éŠ·å”® ${(r.product||"")} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ\n`;
          });
          out += "\n";
        });
      }
      $("historyDisplay").innerText = out;
    }

    function updateTotal(){
      const total = loadMonthly().reduce((s, r)=> s + (Number(r.bonus)||0), 0);
      $("totalBonus").innerText = isFinite(total) ? total.toFixed(0) : "0";
    }

    function calculateBonus(){
      // ä¸å†å¼·åˆ¶è¦æ±‚å§“å/å“åï¼›è‹¥ç©ºç™½ä¹Ÿå…è¨±è¨ˆç®—
      const actual = num($("actualPrice").value);
      const weight = num($("actualWeight").value);
      if (actual === null || weight === null || weight <= 0){
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤å–®åƒ¹èˆ‡é‡é‡");
        return;
      }

      const cost = getBaseFromPriority();
      if (cost === null){
        alert("è«‹å…ˆè¼¸å…¥ã€æˆæœ¬(å…ƒ/kg)ã€æˆ–å›ä¸»é è¨ˆç®—åº•åƒ¹");
        return;
      }

      const deduct = $("homeDelivery").checked ? 250 : 0;
      const addSelf = $("selfDelivery").checked ? weight * 3 : 0;
      const deductDriver = $("companyDriver").checked ? weight * 3 : 0;
      const extraKaoCar = $("kaohsiungLocal").checked ? 5 : 0; // æ•´ç­† -5

      const diff = actual - cost;
      const bonus = diff > 0 ? diff * weight - deduct - deductDriver + addSelf - extraKaoCar : 0;

      $("bonusResult").innerText = isFinite(bonus) ? bonus.toFixed(0) : "0";

      const sales = $("salesName").value.trim();
      const product = $("productName").value.trim();
      const record = {
        date: new Date().toLocaleString(),
        name: sales,
        product,
        weight,
        price: actual,
        total: actual * weight,
        bonus: Number(bonus.toFixed(0))
      };
      const arr = loadMonthly();
      arr.push(record);
      saveMonthly(arr);
      updateTotal(); showHistory();
    }

    function exportCSV(){
      const arr = loadMonthly();
      let csv = "æ¥­å‹™å§“å,éŠ·å”®å“å,æ•¸é‡(kg),æˆäº¤å–®åƒ¹,ç¸½é‡‘é¡,çé‡‘,æ—¥æœŸ\n";
      arr.forEach(r => {
        csv += `${r.name||""},${r.product||""},${r.weight},${r.price},${r.total},${r.bonus},${r.date}\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "æ¥­å‹™çé‡‘å ±è¡¨.csv"; a.click();
    }

    function clearBonus(){
      const arr = loadMonthly();
      if (!arr.length){ alert("ç›®å‰æ²’æœ‰å¯åˆªé™¤çš„ç´€éŒ„"); return; }
      if (!confirm("ç¢ºå®šè¦åˆªé™¤ä¸Šä¸€ç­†çé‡‘ç´€éŒ„ï¼Ÿ")) return;
      arr.pop(); saveMonthly(arr);
      updateTotal(); showHistory();
      alert("å·²åˆªé™¤ä¸Šä¸€ç­†ç´€éŒ„");
    }

    // ---- Init ----
    document.addEventListener("DOMContentLoaded", () => {
      prefillCost();
      updateBaseDisplay();
      handleMonthRollover();
      updateTotal();
      showHistory();

      ["btnCalc","dockCalc"].forEach(id => $(id).addEventListener("click", calculateBonus));
      ["btnExport","dockExport"].forEach(id => $(id).addEventListener("click", exportCSV));
      // ä¸å†è¦†å¯«å›ä¸»é  hrefï¼Œæ²¿ç”¨ HTML æ—¢æœ‰çš„ ./index.html
      ["btnClearOne","dockClearOne"].forEach(id => $(id).addEventListener("click", clearBonus));
      $("costPerKg")?.addEventListener("input", updateBaseDisplay);
    });
  </script>


  <!-- Firebase compat CDN (no UI changes) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    // ğŸ”§ å°‡ä½ çš„ Firebase å°ˆæ¡ˆè¨­å®šå¡«åœ¨é€™è£¡ï¼Œæˆ–åœ¨å¤–éƒ¨æ–¼ window.FIREBASE_CONFIG æŒ‡å®š
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
  apiKey: "AIzaSyAYmv1mt2QV0Ex0J1PlASfZjA3bdBvIJws",
  authDomain: "haishang-a09c3.firebaseapp.com",
  projectId: "haishang-a09c3",
  storageBucket: "haishang-a09c3.firebasestorage.app",
  messagingSenderId: "457535470987",
  appId: "1:457535470987:web:c94320eb296696e132838e"
};
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    // åŒ¿åç™»å…¥ï¼ˆæ–¹ä¾¿å¤šè£ç½®åŒæ­¥ï¼›éœ€ Firestore è¦å‰‡å…è¨±ï¼‰
    try { firebase.auth().signInAnonymously(); } catch(e){ console.warn(e); }
    const db = firebase.firestore();
    // ä½¿ç”¨è€…/è£ç½®è­˜åˆ¥ï¼ˆå¯è‡ªè¡Œè¨­å®šå›ºå®š IDï¼‰
    const PROFILE_ID = localStorage.getItem("profileId") || "default";
  </script>

  <script>
    // === é€²éšï¼šFirestore å¤šè£ç½®åŒæ­¥ï¼ˆbonus.htmlï¼‰ ===
    function ymKey(d = new Date()){
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    }

    // å¯«å…¥ä¸€ç­†ç´€éŒ„åˆ°é›²ç«¯
    async function fsAddRecord(rec){
      try{
        const ym = ymKey(new Date(rec.date));
        await db.collection("profiles").doc(PROFILE_ID)
          .collection("months").doc(ym)
          .collection("records").add({ ...rec, createdAt: Date.now() });
      }catch(err){ console.warn("fsAddRecord:", err); }
    }

    // åˆªé™¤é›²ç«¯æœ€æ–°ä¸€ç­†ï¼ˆä¾ createdAt DESCï¼‰
    async function fsDeleteLastRecord(){
      try{
        const ym = ymKey();
        const q = await db.collection("profiles").doc(PROFILE_ID)
          .collection("months").doc(ym)
          .collection("records").orderBy("createdAt", "desc").limit(1).get();
        if (!q.empty){
          await q.docs[0].ref.delete();
        } else {
          alert("é›²ç«¯ç›®å‰æ²’æœ‰å¯åˆªé™¤ç´€éŒ„");
        }
      }catch(err){ console.warn("fsDeleteLastRecord:", err); }
    }

    // ç›£è½ç•¶æœˆè³‡æ–™ä¸¦å³æ™‚æ›´æ–° UIï¼ˆè·¨è£ç½®åŒæ­¥ï¼‰
    function listenMonthRealtime(){
      const ym = ymKey();
      return db.collection("profiles").doc(PROFILE_ID)
        .collection("months").doc(ym)
        .collection("records").orderBy("createdAt", "asc")
        .onSnapshot(snap => {
          const arr = [];
          snap.forEach(doc => arr.push(doc.data()));
          // æ›´æ–° localStorageï¼ˆåšé›¢ç·šå‚™æ´ï¼‰
          localStorage.setItem("monthlyBonus", JSON.stringify(arr));
          // æ›´æ–°ç•«é¢
          try {
            // å‘¼å«æ—¢æœ‰çš„ UI æ›´æ–°å‡½å¼
            if (typeof updateTotal === "function") updateTotal();
            if (typeof showHistory === "function") showHistory();
          } catch(e){ console.warn(e); }
        }, err => console.warn("listenMonthRealtime:", err));
    }

    // æ›æœˆè™•ç†ï¼šä¸éœ€è¦æ¬ç§»é›²ç«¯è³‡æ–™ï¼Œå› ç‚ºæ¯æœˆå­˜ä¸åŒ doc è·¯å¾‘ï¼›æ¸…ç©ºæœ¬åœ° current é™£åˆ—å³å¯
    function handleMonthRolloverCloudAware(){
      const nowKey = ymKey();
      const last = localStorage.getItem("bonusMonth");
      if (last && last !== nowKey){
        // æŠŠæœ¬åœ° current ç§»å…¥æœ¬åœ° historyï¼ˆä¿æŒä½ åŸæœ¬çš„ UXï¼‰
        const current = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
        const history = JSON.parse(localStorage.getItem("bonusHistory") || "[]");
        history.push({ month: last, data: current });
        localStorage.setItem("bonusHistory", JSON.stringify(history));
        localStorage.setItem("monthlyBonus", "[]");
      }
      localStorage.setItem("bonusMonth", nowKey);
    }

    // æ³¨å…¥åˆ°æ—¢æœ‰çš„æŒ‰éˆ•è¡Œç‚ºï¼šæ–°å¢ã€åˆªé™¤ éƒ½åŒæ­¥é›²ç«¯
    (function wireButtonsForCloud(){
      const adders = ["btnCalc","dockCalc"];
      adders.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const old = el.onclick || (()=>{});
        el.onclick = async function(){
          const before = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
          await old.call(this);
          // æ‰¾å‡ºæ–°åŠ å…¥çš„æœ€å¾Œä¸€ç­†ï¼ˆæœ¬åœ° monthlyBonus å°¾ç«¯ï¼‰ä¸¦å¯«åˆ°é›²ç«¯
          const after = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
          if (after.length > before.length){
            const newRec = after[after.length - 1];
            fsAddRecord(newRec);
          }
        };
      });
      const deleters = ["btnClearOne","dockClearOne"];
      deleters.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const old = el.onclick || (()=>{});
        el.onclick = async function(){
          await old.call(this);
          fsDeleteLastRecord();
        };
      });
    })();

    // å•Ÿå‹•ï¼šè™•ç†æ›æœˆã€å•Ÿç”¨å³æ™‚ç›£è½
    (function initCloudSync(){
      handleMonthRolloverCloudAware();
      listenMonthRealtime(); // returns unsubscribeï¼Œä½†é€™å€‹é é¢ç”Ÿå‘½å‘¨æœŸå…§å¯ä¸ç‰¹åˆ¥è™•ç†
    })();
  </script>


  <script>
    // ===== ä¿®æ­£ï¼šæœˆä»½éµä¸€è‡´åŒ–èˆ‡æ›´ç©©å¥çš„æ›æœˆé‚è¼¯ =====
    // çµ±ä¸€ä½¿ç”¨ YYYY-MMï¼ˆå…©ä½æ•¸æœˆä»½ï¼‰ï¼Œä¸¦åœ¨è¼‰å…¥æ™‚è‡ªå‹•æŠŠèˆŠæ ¼å¼ï¼ˆYYYY-Mï¼‰è½‰æ›
    (function monthKeyPatching(){
      function ymKeyPad(d){
        const dt = d instanceof Date ? d : new Date(d);
        return dt.getFullYear() + "-" + String(dt.getMonth()+1).padStart(2,"0");
      }
      // æŠŠ localStorage çš„ bonusMonth èˆŠå€¼ "YYYY-M" è½‰æˆ "YYYY-MM"ï¼Œé¿å…æ ¼å¼å·®ç•°èª¤åˆ¤è·¨æœˆ
      const raw = localStorage.getItem("bonusMonth");
      if (raw && /^\d{4}-\d{1,2}$/.test(raw)){
        const [y,m] = raw.split("-");
        const patched = y + "-" + String(parseInt(m,10)).padStart(2,"0");
        localStorage.setItem("bonusMonth", patched);
      }
      // å¦‚æœæœ¬åœ° current è¨˜éŒ„å‰›è¼¸å…¥ä½†è¢«èª¤æ­¸åˆ° historyï¼Œé€šå¸¸æ˜¯å› ç‚ºæ ¼å¼ä¸åŒå°è‡´çš„è·¨æœˆèª¤åˆ¤
      // æˆ‘å€‘é€™è£¡ä¸è‡ªå‹•æ¬å›ï¼ˆé¿å…å½±éŸ¿ä½ çš„æ­·å²ï¼‰ï¼Œä½†ä¹‹å¾Œåªæœƒç”¨ YYYY-MMï¼Œå•é¡Œä¸æœƒå†ç™¼ç”Ÿ
      // ä½ ä»å¯ç”¨ã€Œæ¸…é™¤ä¸Šä¸€ç­†ã€åˆªé™¤æœ¬æœˆæœ€å¾Œä¸€ç­†ï¼›æ­·å²æœˆä¸æœƒè¢«åˆª
    })();

    // è¦†å¯«é é¢ä¸Šå·²å®£å‘Šçš„ ymKey èˆ‡æ›æœˆå‡½å¼ï¼Œæ”¹ç‚ºåªæ¯”è¼ƒæ•¸å€¼æœˆä»½ï¼Œå¿½ç•¥æ ¼å¼å·®ç•°
    (function overrideMonthHelpers(){
      window.ymKey = function(d = new Date()){
        return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
      };
      const _oldHandle = window.handleMonthRolloverCloudAware || window.handleMonthRollover;
      window.handleMonthRolloverCloudAware = function(){
        const nowKey = ymKey();
        const last = localStorage.getItem("bonusMonth");
        if (last){
          // åŒæ­¥è£œé›¶å†æ¯”è¼ƒ
          const normLast = /^\d{4}-\d{1,2}$/.test(last) ? (last.split("-")[0] + "-" + String(parseInt(last.split("-")[1],10)).padStart(2,"0")) : last;
          if (normLast !== nowKey){
            const current = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
            const history = JSON.parse(localStorage.getItem("bonusHistory") || "[]");
            history.push({ month: normLast, data: current });
            localStorage.setItem("bonusHistory", JSON.stringify(history));
            localStorage.setItem("monthlyBonus", "[]");
          }
        }
        localStorage.setItem("bonusMonth", nowKey);
      };
    })();

    // è¦†å¯«åˆªé™¤ä¸Šä¸€ç­†ï¼šåªåˆªã€Œæœ¬æœˆã€çš„æœ€å¾Œä¸€ç­†ï¼›æ­·å²æœˆä»½ä¸å—å½±éŸ¿
    (function overrideDeleteLast(){
      const fsDeleteLastRecord = async function(){
        try{
          const ym = ymKey();
          const q = await db.collection("profiles").doc(PROFILE_ID)
            .collection("months").doc(ym)
            .collection("records").orderBy("createdAt", "desc").limit(1).get();
          if (!q.empty){ await q.docs[0].ref.delete(); }
        }catch(e){ console.warn(e); }
      };
      const localDelete = function(){
        const ym = ymKey();
        const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
        if (!arr.length){ alert("æœ¬æœˆç›®å‰æ²’æœ‰å¯åˆªé™¤çš„ç´€éŒ„"); return false; }
        arr.pop();
        localStorage.setItem("monthlyBonus", JSON.stringify(arr));
        return true;
      };
      function bind(id){
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("click", async (ev)=>{
          // æ””æˆªåŸæœ¬èˆŠçš„ onclickï¼ˆè‹¥å­˜åœ¨ä¹Ÿå¯å…±å­˜ï¼‰
          ev.preventDefault();
          if (!confirm("ç¢ºå®šè¦åˆªé™¤ã€Œæœ¬æœˆä»½ã€ä¸Šä¸€ç­†ç´€éŒ„ï¼Ÿï¼ˆä¸æœƒå½±éŸ¿æ­·å²æœˆä»½ï¼‰")) return;
          const ok = localDelete();
          if (ok){
            if (typeof updateTotal === "function") updateTotal();
            if (typeof showHistory === "function") showHistory();
            try{ await fsDeleteLastRecord(); }catch(e){ console.warn(e); }
            alert("å·²åˆªé™¤æœ¬æœˆä»½ä¸Šä¸€ç­†ç´€éŒ„");
          }
        }, { once:false });
      }
      ["btnClearOne","dockClearOne"].forEach(bind);
    })();
  </script>


  <script>
    // ===== åªé¡¯ç¤ºæœ¬æœˆç´€éŒ„ + æ”¯æ´é€ç­†åˆªé™¤ =====
    (function enhanceMonthlyViewAndDelete(){
      const $ = (id)=> document.getElementById(id);
      const ymKey = (d = new Date()) => d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");

      // é‡æ–°åŒ…è£ onSnapshot è®“æœ¬åœ° monthlyBonus é™£åˆ—å¸¶ä¸Š _idï¼ˆFirestore doc idï¼‰ï¼Œä¾¿æ–¼é›²ç«¯é€ç­†åˆªé™¤
      if (typeof db !== "undefined" && db && typeof listenMonthRealtime === "function"){
        // è§£é™¤èˆŠç›£è½ï¼ˆè‹¥ä½ çš„ç‰ˆæœ¬æ”¯æ´å›å‚³ unsubscribe å¯åœ¨ window._unsubMonthly å­˜å–ï¼‰
        try{ if (window._unsubMonthly) { window._unsubMonthly(); } }catch(e){}
        window._unsubMonthly = (function(){
          const ym = ymKey();
          return db.collection("profiles").doc(PROFILE_ID)
            .collection("months").doc(ym)
            .collection("records").orderBy("createdAt","asc")
            .onSnapshot(snap => {
              const arr = [];
              snap.forEach(doc => {
                const d = doc.data();
                // ä¿å­˜ Firestore doc id ä¾›åˆªé™¤ä½¿ç”¨
                arr.push(Object.assign({_id: doc.id}, d));
              });
              localStorage.setItem("monthlyBonus", JSON.stringify(arr));
              try {
                if (typeof updateTotal === "function") updateTotal();
                if (typeof showHistory === "function") showHistory();
              } catch(e){ console.warn(e); }
            }, err => console.warn("listenMonthRealtime+", err));
        })();
      }

      // è¦†å¯« showHistoryï¼šåªé¡¯ç¤ºæœ¬æœˆ
      window.showHistory = function(){
        const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
        let out = "ğŸ“˜ æœ¬æœˆç´€éŒ„ï¼š\n";
        if (!arr.length){
          out += "ï¼ˆå°šç„¡ï¼‰\n";
        }else{
          arr.forEach((r, i) => {
            const line = `  ğŸ•’ ${r.date||""} - ${(r.name||"")} éŠ·å”® ${(r.product||"")} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ`;
            out += line + `  [åˆªé™¤æ­¤ç­† #${i+1}]\n`;
          });
          out += "\nï¼ˆæç¤ºï¼šé»ä¸‹æ–¹ã€åˆ·æ–°æœ¬æœˆç´€éŒ„ã€å¯æ›´æ–°é¡¯ç¤ºï¼‰\n";
        }
        $("historyDisplay").innerText = out;

        // åŒæ­¥åœ¨æ–‡å­—å€ä¸‹æ–¹ç”ŸæˆæŒ‰éˆ•ï¼ˆç„¡æ”¹ç‰ˆï¼Œåƒ…é™„åŠ ï¼‰
        const containerId = "monthlyDeleteButtons";
        let c = document.getElementById(containerId);
        if (!c){
          c = document.createElement("div");
          c.id = containerId;
          c.style.marginTop = "8px";
          $("historyDisplay").parentElement.appendChild(c);
        }
        c.innerHTML = "";
        arr.forEach((_, i) => {
          const btn = document.createElement("button");
          btn.textContent = "åˆªé™¤ç¬¬ " + (i+1) + " ç­†";
          btn.className = "btn danger";
          btn.style.marginRight = "8px";
          btn.addEventListener("click", ()=> deleteMonthlyByIndex(i));
          c.appendChild(btn);
        });
        const refreshBtn = document.createElement("button");
        refreshBtn.textContent = "åˆ·æ–°æœ¬æœˆç´€éŒ„";
        refreshBtn.className = "btn";
        refreshBtn.addEventListener("click", ()=> window.showHistory());
        c.appendChild(refreshBtn);
      };

      async function deleteMonthlyByIndex(index){
        const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
        if (index < 0 || index >= arr.length){ alert("ç´¢å¼•è¶…å‡ºç¯„åœ"); return; }
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†ï¼ˆåƒ…æœ¬æœˆï¼‰ï¼Ÿ")) return;

        // å…ˆè¨˜ä¸‹æ¬²åˆªé™¤é …ï¼Œä»¥ä¾¿é›²ç«¯åˆªé™¤
        const target = arr[index];

        // æœ¬åœ°åˆªé™¤
        arr.splice(index, 1);
        localStorage.setItem("monthlyBonus", JSON.stringify(arr));
        if (typeof updateTotal === "function") updateTotal();
        if (typeof showHistory === "function") showHistory();

        // é›²ç«¯åˆªé™¤ï¼ˆè‹¥å¯ç”¨ï¼‰
        try{
          if (typeof db !== "undefined" && db){
            const ym = ymKey();
            if (target && target._id){
              // ç›´æ¥ç”¨ doc id åˆªé™¤
              await db.collection("profiles").doc(PROFILE_ID)
                .collection("months").doc(ym)
                .collection("records").doc(target._id).delete();
            }else if (typeof target?.createdAt === "number"){
              // é€€è€Œæ±‚å…¶æ¬¡ï¼šä»¥ createdAt æ¯”å°åˆªé™¤
              const q = await db.collection("profiles").doc(PROFILE_ID)
                .collection("months").doc(ym)
                .collection("records").where("createdAt", "==", target.createdAt).limit(1).get();
              if (!q.empty){ await q.docs[0].ref.delete(); }
            }else{
              // æœ€å¾Œæ–¹æ¡ˆï¼šæŠ“è¿‘ 50 ç­†ï¼Œæ¯”å°ä¸»è¦æ¬„ä½å¾Œåˆªé™¤ç¬¬ä¸€å€‹ç›¸ç¬¦
              const snap = await db.collection("profiles").doc(PROFILE_ID)
                .collection("months").doc(ym)
                .collection("records").orderBy("createdAt","desc").limit(50).get();
              let deleted = false;
              snap.forEach(doc => {
                const d = doc.data();
                if (!deleted &&
                    d.name === target.name &&
                    d.product === target.product &&
                    Number(d.weight) === Number(target.weight) &&
                    Number(d.price) === Number(target.price) &&
                    Number(d.bonus) === Number(target.bonus) ){
                  deleted = true;
                  doc.ref.delete();
                }
              });
            }
          }
        }catch(e){ console.warn("cloud delete by index failed:", e); }
      }

      // åˆæ¬¡æ¸²æŸ“
      document.addEventListener("DOMContentLoaded", ()=> {
        try{ showHistory(); }catch(e){ console.warn(e); }
      });
    })();
  </script>

</body>
</html>
