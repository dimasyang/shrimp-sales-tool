<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆé›²ç«¯ç°¡åŒ–ç‰ˆ v2ï¼‰</title>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--bd:#ddd;--muted:#666;--brand:#4f8cff;--brand2:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:-apple-system,system-ui,"Microsoft JhengHei",sans-serif;color:#111}
    .container{max-width:1000px;margin:0 auto;padding:16px 16px 80px}
    h1{margin:0 0 4px}
    .lead{margin:0 0 12px;color:#374151;font-size:14px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){
      .grid-2{grid-template-columns:repeat(2,1fr)}
      .grid-3{grid-template-columns:repeat(3,1fr)}
      .grid-4{grid-template-columns:repeat(4,1fr)}
    }
    label span{display:block;font-size:12px;color:#4b5563;margin-bottom:4px}
    input:not([type=checkbox]),button,select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--bd);font-size:14px}
    button{cursor:pointer;background:#f3f4f6}
    button.primary{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#fff;border:none;font-weight:600}
    button.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    button.danger{background:#fde2e2;border-color:#f5c2c7;color:#842029}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .row > *{flex:1 1 auto}
    .mini{font-size:12px;color:#6b7280;margin-top:4px}
    .strong{font-weight:600}
    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
    @media(max-width:600px){.actions{grid-template-columns:1fr}}
    #bonusResult{font-size:20px;font-weight:700;color:#b91c1c}
    .table-wrap{margin-top:10px;border:1px solid #e5e7eb;border-radius:10px;overflow:auto;max-height:420px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:720px}
    thead th{position:sticky;top:0;background:#fafafa;border-bottom:1px solid #e5e7eb;padding:8px 10px;font-size:13px;text-align:left}
    tbody td{border-bottom:1px solid #f3f4f6;padding:6px 10px;font-size:13px;white-space:nowrap}
    tbody tr:nth-child(odd){background:#fcfcfc}
    #status{font-size:12px;margin-top:4px}
    #status.ok{color:#16a34a}
    #status.err{color:#b91c1c}
    #mode{font-size:12px;margin-top:2px;color:#4b5563}
    #loadStatus{font-size:12px;margin-top:2px;color:#4b5563}
    .btn-del{font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid #fecaca;background:#fee2e2;color:#b91c1c}
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Firestore å°ˆæ¡ˆè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };

    let db = null;
    let useFirestore = false; // true = å„ªå…ˆ Firestore

    function initFirebaseSafe() {
      try {
        if (typeof firebase === "undefined") {
          console.warn("Firebase SDK æœªè¼‰å…¥ï¼Œæ”¹ç”¨æœ¬æ©Ÿæ¨¡å¼");
          useFirestore = false;
          return;
        }
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        useFirestore = true;

        firebase.auth().signInAnonymously().catch(function(e){
          console.warn("åŒ¿åç™»å…¥å¤±æ•—", e);
        });

        firebase.auth().onAuthStateChanged(function(user){
          const statusEl = document.getElementById("status");
          if (!statusEl) return;
          statusEl.textContent = "å·²é€£ç·š Firebaseï¼š" + firebase.app().options.projectId;
          statusEl.className = "mini ok";
          document.getElementById("mode").textContent = "å„²å­˜æ¨¡å¼ï¼šFirestoreï¼ˆé›²ç«¯å„ªå…ˆï¼‰";
        });
      } catch (e) {
        console.warn("åˆå§‹åŒ– Firebase å¤±æ•—", e);
        const statusEl = document.getElementById("status");
        if (statusEl) {
          statusEl.textContent = "Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿæ¨¡å¼ï¼š" + (e.message || e);
          statusEl.className = "mini err";
        }
        useFirestore = false;
      }
    }

    // æœ¬æ©Ÿè³‡æ–™å­˜å–
    function loadLocalAllData(){
      try{
        const raw = localStorage.getItem("bonusLocalData_cloud");
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        console.error("parse local data error", e);
        return {};
      }
    }
    function saveLocalAllData(obj){
      localStorage.setItem("bonusLocalData_cloud", JSON.stringify(obj));
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆé›²ç«¯ç°¡åŒ–ç‰ˆ v2ï¼‰</h1>
    <p class="lead">
      âœ… ä½¿ç”¨èˆŠç³»çµ±åŒä¸€å€‹è·¯å¾‘ï¼šprofiles/default/months/{YYYY-MM}/recordsã€‚<br>
      âœ… é¡å¤–ç”¨ã€Œæ—¥æœŸæ¬„ä½ã€å†éæ¿¾ä¸€æ¬¡ï¼Œåªé¡¯ç¤ºæ‰€é¸æœˆä»½ï¼ˆä¸æœƒå‡ºç¾ã€ŒæŸ¥ 11 æœˆè·‘å‡º 9 æœˆã€çš„ç‹€æ³ï¼‰ã€‚
    </p>

    <!-- æŸ¥è©¢æœˆä»½ -->
    <section class="card">
      <div class="row">
        <label style="max-width:220px;">
          <span>æŸ¥è©¢æœˆä»½ï¼ˆYYYY-MMï¼‰</span>
          <input type="month" id="monthInput">
        </label>
        <button class="primary" id="btnLoad">è¼‰å…¥æœ¬æœˆç´€éŒ„</button>
        <button id="btnThisMonth">ä»Šå¤©æ‰€åœ¨æœˆä»½</button>
      </div>
      <div id="status" class="mini">åˆå§‹åŒ–ä¸­â€¦</div>
      <div id="mode" class="mini"></div>
      <div id="loadStatus" class="mini"></div>
      <div id="summary" class="strong mini">æœ¬æœˆçé‡‘åˆè¨ˆï¼š0 å…ƒï¼ˆ0 ç­†ï¼‰</div>
    </section>

    <!-- æ–°å¢ -->
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px;">âœï¸ æ–°å¢äº¤æ˜“</h2>
      <div class="grid grid-2">
        <label><span>æ¥­å‹™å§“å</span><input id="salesName"></label>
        <label><span>å“å</span><input id="productName"></label>
        <label><span>é‡é‡ (kg)</span><input id="actualWeight" type="number" step="0.01"></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input id="actualPrice" type="number" step="0.01"></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input id="costPerKg" type="number" step="0.01"></label>
        <label><span>äº¤æ˜“æ—¥æœŸ</span><input id="recordDate" type="date"></label>
      </div>

      <div class="grid grid-4" style="margin-top:8px;">
        <label><input type="checkbox" id="homeDelivery"> å®…é… -250</label>
        <label><input type="checkbox" id="selfDelivery"> è‡ªè¡Œé…é€ +3/kg</label>
        <label><input type="checkbox" id="companyDriver"> å…¬å¸å¸æ©Ÿ -3/kg</label>
        <label><input type="checkbox" id="kaohsiungLocal"> é«˜é›„å¸‚å€ +5</label>
      </div>

      <div class="actions">
        <button class="primary" id="btnCalc">è¨ˆç®—ä¸¦å„²å­˜</button>
        <button class="ok" id="btnExport">åŒ¯å‡º CSV</button>
        <button class="danger" id="btnClearForm">æ¸…ç©º</button>
      </div>

      <p class="mini">è¨˜æ†¶æˆæœ¬ï¼š<span id="basePriceDisplay">-</span> å…ƒ/kg</p>
      <p class="strong">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>
    </section>

    <!-- åˆ—è¡¨ -->
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:16px;">ğŸ“‹ ç•¶æœˆç´€éŒ„</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th><th>æ—¥æœŸ</th><th>æ¥­å‹™</th><th>å“å</th>
              <th>é‡é‡</th><th>å–®åƒ¹</th><th>ç¸½é¡</th><th>çé‡‘</th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);

function ymFromDateInput(dateStr){
  // æ”¯æ´ YYYY-MM-DD æˆ– YYYY/M/D
  if(!dateStr) return "";
  const m = String(dateStr).match(/(\d{4})[\/\-](\d{1,2})/);
  if(!m) return "";
  return m[1] + "-" + String(parseInt(m[2],10)).padStart(2,"0");
}

function formatDateOnly(v){
  if(!v) return "";
  // å…è¨±åƒ "2025/9/2 ä¸Šåˆ10:09:35"
  const m = String(v).match(/(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/);
  if(m) return m[1];
  return v;
}

// æœ¬æ©Ÿå¿«å–
let localAllData = loadLocalAllData(); // { "YYYY-MM": [records...] }
let currentMonth = "";
let currentRows = [];

async function loadMonthRecords(){
  const m = $("monthInput").value;
  if(!m){ alert("è«‹å…ˆé¸æ“‡æœˆä»½"); return; }
  currentMonth = m;
  $("loadStatus").textContent = "è¼‰å…¥ä¸­â€¦";
  $("recordsBody").innerHTML = "";
  currentRows = [];

  // å„ªå…ˆå¾ Firestore è®€
  if(useFirestore && db){
    try{
      const col = db.collection("profiles").doc("default")
        .collection("months").doc(m)
        .collection("records").orderBy("createdAt","asc");
      const snap = await col.get();
      const allRows = snap.docs.map(d=>Object.assign({id:d.id}, d.data()));

      // â­ å†ç”¨æ—¥æœŸæ¬„ä½éæ¿¾ä¸€æ¬¡ï¼Œåªä¿ç•™çœŸæ­£å±¬æ–¼ m çš„è³‡æ–™
      const filtered = allRows.filter(r=>{
        const datePart = (r.date || "").split(" ")[0] || r.date;
        return ymFromDateInput(datePart) === m;
      });

      currentRows = filtered;
      // åŒæ­¥åˆ°æœ¬æ©Ÿ
      localAllData[m] = currentRows;
      saveLocalAllData(localAllData);
      renderTable();
      $("loadStatus").textContent = `å·²å¾ Firestore è¼‰å…¥ ${m}ï¼Œå…± ${currentRows.length} ç­†ç´€éŒ„ã€‚`;
      return;
    }catch(e){
      console.warn("è®€å– Firestore å¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿè³‡æ–™", e);
      $("status").textContent = "è®€å– Firestore å¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿï¼š" + (e.message||e);
      $("status").className = "mini err";
    }
  }

  // Firestore ä¸å¯ç”¨ or è®€å–å¤±æ•— â†’ ç”¨æœ¬æ©Ÿå¿«å–
  const allRows = localAllData[m] || [];
  currentRows = allRows.filter(r=>{
    const datePart = (r.date || "").split(" ")[0] || r.date;
    return ymFromDateInput(datePart) === m;
  });
  renderTable();
  $("mode").textContent = "å„²å­˜æ¨¡å¼ï¼šæœ¬æ©Ÿ localStorage";
  $("loadStatus").textContent = `å·²å¾æœ¬æ©Ÿè¼‰å…¥ ${m}ï¼Œå…± ${currentRows.length} ç­†ç´€éŒ„ã€‚`;
}

function renderTable(){
  const tb = $("recordsBody");
  tb.innerHTML = "";
  let sum = 0;
  currentRows.forEach((r,i)=>{
    sum += Number(r.bonus || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${formatDateOnly(r.date)}</td>
      <td>${r.name||""}</td>
      <td>${r.product||""}</td>
      <td>${r.weight}</td>
      <td>${r.price}</td>
      <td>${r.total}</td>
      <td>${r.bonus}</td>
      <td><button class="btn-del" data-index="${i}">åˆªé™¤</button></td>`;
    tb.appendChild(tr);
  });
  $("summary").textContent = `æœ¬æœˆçé‡‘åˆè¨ˆï¼š${sum} å…ƒï¼ˆ${currentRows.length} ç­†ï¼‰`;
}

async function deleteRecord(index){
  const rec = currentRows[index];
  if(!rec){ alert("æ‰¾ä¸åˆ°é€™ç­†ç´€éŒ„"); return; }

  const ym = ymFromDateInput(formatDateOnly(rec.date));
  if(!ym){ alert("é€™ç­†ç´€éŒ„çš„æ—¥æœŸæ ¼å¼æœ‰å•é¡Œï¼Œç„¡æ³•åˆ¤æ–·æœˆä»½"); return; }

  // å…ˆå¾ç›®å‰åˆ—è¡¨ç§»é™¤
  currentRows.splice(index,1);

  // åŒæ­¥æ›´æ–°æœ¬æ©Ÿå¿«å–
  if(!localAllData[ym]) localAllData[ym] = [];
  localAllData[ym] = currentRows.slice();
  saveLocalAllData(localAllData);

  let deletedFrom = "æœ¬æ©Ÿ localStorage";

  // å†å˜—è©¦åˆªé™¤ Firestore
  if(useFirestore && db && rec.id){
    try{
      await db.collection("profiles").doc("default")
        .collection("months").doc(ym)
        .collection("records").doc(rec.id).delete();
      deletedFrom = "Firestoreï¼ˆé›²ç«¯ï¼‰ï¼‹æœ¬æ©Ÿ";
    }catch(e){
      console.warn("åˆªé™¤ Firestore å¤±æ•—ï¼Œåƒ…åˆªæœ¬æ©Ÿ", e);
      $("status").textContent = "åˆªé™¤ Firestore å¤±æ•—ï¼Œåƒ…åˆªæœ¬æ©Ÿï¼š" + (e.message||e);
      $("status").className = "mini err";
    }
  }

  renderTable();
  $("loadStatus").textContent = `å·²åˆªé™¤ 1 ç­†ï¼ˆ${deletedFrom}ï¼‰ã€‚`;
}

async function calculateAndSave(){
  const cost = parseFloat($("costPerKg").value);
  const price = parseFloat($("actualPrice").value);
  const w = parseFloat($("actualWeight").value);
  const d = $("recordDate").value;

  if(!d){ alert("è«‹é¸äº¤æ˜“æ—¥æœŸ"); return; }
  if(!isFinite(price) || !isFinite(w) || w<=0){ alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡é‡èˆ‡å–®åƒ¹"); return; }
  if(!isFinite(cost)){ alert("è«‹è¼¸å…¥æˆæœ¬"); return; }

  localStorage.setItem("basePrice", cost);
  $("basePriceDisplay").textContent = cost;

  let bonus = (price - cost) * w;
  if($("homeDelivery").checked) bonus -= 250;
  if($("selfDelivery").checked) bonus += 3*w;
  if($("companyDriver").checked) bonus -= 3*w;
  if($("kaohsiungLocal").checked) bonus += 5;
  bonus = Math.round(Math.max(bonus, 0));
  $("bonusResult").textContent = bonus;

  const ym = ymFromDateInput(d);
  if(!ym){ alert("æ—¥æœŸæ ¼å¼æœ‰å•é¡Œ"); return; }

  const rec = {
    date: d + " 00:00",
    name: $("salesName").value.trim(),
    product: $("productName").value.trim(),
    weight: w,
    price: price,
    total: Math.round(price*w*100)/100,
    bonus: bonus,
    createdAt: Date.now()
  };

  // å…ˆå¯«å…¥æœ¬æ©Ÿ
  if(!localAllData[ym]) localAllData[ym] = [];
  localAllData[ym].push(rec);
  saveLocalAllData(localAllData);

  let savedTo = "æœ¬æ©Ÿ localStorage";

  // å†å˜—è©¦å¯«å…¥ Firestore
  if(useFirestore && db){
    try{
      const docRef = await db.collection("profiles").doc("default")
        .collection("months").doc(ym)
        .collection("records").add(rec);
      rec.id = docRef.id; // â­ é‡è¦ï¼šä¿å­˜ Firestore idï¼Œä¾›æ—¥å¾Œåˆªé™¤
      savedTo = "Firestoreï¼ˆé›²ç«¯ï¼‰ï¼‹æœ¬æ©Ÿ";
    }catch(e){
      console.warn("å¯«å…¥ Firestore å¤±æ•—ï¼Œåƒ…å­˜æœ¬æ©Ÿ", e);
      $("status").textContent = "å¯«å…¥ Firestore å¤±æ•—ï¼Œåƒ…å­˜æœ¬æ©Ÿï¼š" + (e.message||e);
      $("status").className = "mini err";
    }
  }

  if(currentMonth === ym){
    currentRows.push(rec);
    renderTable();
  }

  $("loadStatus").textContent = `å·²å„²å­˜ 1 ç­†åˆ° ${ym}ï¼ˆ${savedTo}ï¼‰ã€‚`;
  alert("å·²å®Œæˆè¨ˆç®—ä¸¦å„²å­˜ï¼ˆ" + savedTo + "ï¼‰ï¼");
}

function exportCsv(){
  if(!currentRows.length){ alert("ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„"); return; }
  let csv = "æ¥­å‹™,å“å,é‡é‡,å–®åƒ¹,ç¸½é¡,çé‡‘,æ—¥æœŸ\n";
  currentRows.forEach(r=>{
    csv += `${r.name||""},${r.product||""},${r.weight},${r.price},${r.total},${r.bonus},${formatDateOnly(r.date)}\n`;
  });
  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `bonus_${currentMonth||"all"}.csv`;
  a.click();
}

function clearForm(){
  ["salesName","productName","actualWeight","actualPrice","recordDate"].forEach(id=>$(id).value="");
  ["homeDelivery","selfDelivery","companyDriver","kaohsiungLocal"].forEach(id=>$(id).checked=false);
  $("bonusResult").textContent = "0";
}

document.addEventListener("DOMContentLoaded", ()=>{
  const t = new Date();
  const y = t.getFullYear();
  const m = String(t.getMonth()+1).padStart(2,"0");
  const d = String(t.getDate()).padStart(2,"0");
  $("recordDate").value = `${y}-${m}-${d}`;
  $("monthInput").value = `${y}-${m}`;

  const bp = localStorage.getItem("basePrice");
  if(bp){
    $("costPerKg").value = bp;
    $("basePriceDisplay").textContent = bp;
  }

  // åˆå§‹åŒ– Firebase
  initFirebaseSafe();
  if(!useFirestore){
    $("status").textContent = "Firebase ä¸å¯ç”¨ï¼Œæš«æ™‚ä½¿ç”¨æœ¬æ©Ÿ localStorageã€‚";
    $("status").className = "mini err";
    $("mode").textContent = "å„²å­˜æ¨¡å¼ï¼šæœ¬æ©Ÿ localStorage";
  }

  $("btnLoad").onclick = loadMonthRecords;
  $("btnThisMonth").onclick = ()=>{ $("monthInput").value = `${y}-${m}`; loadMonthRecords(); };
  $("btnCalc").onclick = calculateAndSave;
  $("btnExport").onclick = exportCsv;
  $("btnClearForm").onclick = clearForm;

  // åˆ—è¡¨ä¸­çš„åˆªé™¤æŒ‰éˆ•ï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
  $("recordsBody").addEventListener("click", async (e)=>{
    const btn = e.target.closest(".btn-del");
    if(!btn) return;
    const index = Number(btn.dataset.index);
    if(Number.isNaN(index)) return;
    const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ\nï¼ˆé›²ç«¯èˆ‡æœ¬æ©Ÿè³‡æ–™å°‡ä¸€ä½µåˆªé™¤ï¼‰");
    if(!ok) return;
    await deleteRecord(index);
  });

  // é€²ä¾†å°±å…ˆè¼‰å…¥ç•¶æœˆ
  loadMonthRecords();
});
</script>
</body>
</html>
