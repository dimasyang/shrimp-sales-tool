<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆå¯é¸æœˆä»½ v5dï½œå®¹éŒ¯å¼·åŒ–ï¼‰</title>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--bd:#ddd;--muted:#666;--brand:#4f8cff;--brand2:#7aa2ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;color:#222}
    .container{max-width:1000px;margin:0 auto;padding:16px 16px 120px}
    h1{margin:0 0 8px}.lead{color:#374151;margin:0 0 8px}
    small.hint{color:#6b7280}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
    input:not([type=checkbox]):not([type=radio]),button,a.btn{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    label span{display:block;font-size:12px;color:#475569;margin-bottom:6px}
    .btn{cursor:pointer;background:#f3f4f6;text-align:center;text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#fff;border:none;font-weight:600}
    .btn.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    .btn.danger{background:#fde2e2;border-color:#f5c2c7;color:#842029}
    .actions{display:grid;gap:10px;grid-template-columns:1fr 1fr} @media(min-width:640px){.actions{grid-template-columns:repeat(4,1fr)}}
    .table{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px;margin-top:12px}
    pre{white-space:pre-wrap}
    .seg{display:inline-grid;grid-auto-flow:column;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;padding:6px;border-radius:999px}
    .seg button{border:none;background:transparent;padding:6px 12px;border-radius:999px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:#4f46e5;color:#fff}
    .dbg-footer{position:fixed;left:12px;bottom:12px;z-index:9999;background:rgba(17,24,39,.95);color:#e5e7eb;padding:10px 12px;border-radius:12px;border:1px solid #374151;max-width:90vw;font:12px ui-monospace,Menlo,Consolas,monospace}
    .dbg-footer .k{color:#93c5fd}.dbg-footer .v{color:#86efac}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mini{font-size:12px;color:#6b7280}
    .err{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
    <p class="lead">è‡ªç”±é¸æ“‡æœˆä»½è¼‰å…¥ï¼ˆæœ€å¤šå…©å€‹æœˆï¼Œå¯åªé¸ä¸€å€‹ï¼‰ï½œæ”¯æ´åˆä½µ/å–®æœˆæª¢è¦–ï½œCSV åŒ¯å‡º</p>

    <!-- æœˆä»½æ§åˆ¶ -->
    <section class="card">
      <div class="row">
        <label><span>æœˆä»½ A</span><input id="monthA" type="month" /></label>
        <label><span>æœˆä»½ Bï¼ˆå¯ç•™ç©ºï¼‰</span><input id="monthB" type="month" /></label>
        <button class="btn primary" id="btnLoadMonths" style="width:auto;">è¼‰å…¥æ‰€é¸æœˆä»½</button>
        <button class="btn" id="btnQuickNowPrev" style="width:auto;">ä¸€éµè¼‰å…¥ï¼šæœ¬æœˆï¼‹ä¸Šæœˆ</button>
        <div class="seg" role="tablist">
          <button id="viewA" role="tab" aria-pressed="false">åƒ… A</button>
          <button id="viewAB" role="tab" aria-pressed="true">åˆä½µ A+B</button>
          <button id="viewB" role="tab" aria-pressed="false">åƒ… B</button>
        </div>
      </div>
      <div class="mini" id="authHint" style="margin-top:6px;display:none;">âš ï¸ å°šæœªç™»å…¥ï¼ˆåŒ¿åï¼‰ã€‚</div>
      <div class="mini"><strong>ç‹€æ…‹ï¼š</strong><span id="ping" class="err"></span></div>
      <div style="margin-top:8px;font-weight:600;color:#374151;">
        A æœˆï¼š<span id="sumA">0</span> å…ƒï½œB æœˆï¼š<span id="sumB">0</span> å…ƒ
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <p>æ¯å…¬æ–¤åº•åƒ¹ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š<span id="basePriceDisplay" class="em">-</span> å…ƒ</p>
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input id="salesName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>éŠ·å”®å“å</span><input id="productName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input id="actualWeight" type="number" placeholder="0"/></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input id="actualPrice" type="number" placeholder="0"/></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input id="costPerKg" type="number" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œå¯æ‰‹å‹•ä¿®æ”¹"/></label>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <label><input type="checkbox" id="homeDelivery"/> å®…é…ï¼ˆæ‰£250å…ƒï¼‰</label>
        <label><input type="checkbox" id="selfDelivery"/> è‡ªè¡Œé…é€ï¼ˆæ¯å…¬æ–¤åŠ 3å…ƒï¼‰</label>
        <label><input type="checkbox" id="companyDriver"/> å…¬å¸å¸æ©Ÿï¼ˆæ¯å…¬æ–¤æ‰£3å…ƒï¼‰</label>
        <label><input type="checkbox" id="kaohsiungLocal"/> é«˜é›„å¸‚å€å…¬å¸è»Šï¼ˆæ•´ç­† +5 å…ƒï¼‰</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—çé‡‘</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <a class="btn primary" href="./index.html">è¿”å›ä¸»é </a>
        <button class="btn danger" id="btnDelPicked">åˆªé™¤é¸å–ç´€éŒ„</button>
      </div>

      <p class="em">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>

      <div class="table">
        <strong>ç´€éŒ„åˆ—è¡¨</strong>
        <pre id="historyDisplay"></pre>
      </div>
    </section>
  </div>

  <!-- Debug footer -->
  <div class="dbg-footer" id="dbgFoot">
    <div><span class="k">projectId</span>: <span class="v" id="dbgProject">â€”</span> ï½œ <span class="k">UID</span>: <span class="v" id="dbgUid">â€”</span></div>
    <div><span class="k">A</span>: <span class="v" id="dbgYmA">â€”</span>ï¼ˆ<span class="k">count</span>: <span class="v" id="dbgCntA">0</span>ï¼‰ ï½œ <span class="k">B</span>: <span class="v" id="dbgYmB">â€”</span>ï¼ˆ<span class="k">count</span>: <span class="v" id="dbgCntB">0</span>ï¼‰</div>
    <div id="dbgLog" style="margin-top:6px;white-space:pre-wrap"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    try { db.enablePersistence({synchronizeTabs:true}); } catch(e){}
    firebase.auth().signInAnonymously().catch(()=>{});

    const $ = id=>document.getElementById(id);
    const set = (id, v)=>{ const el=$(id); if(el) el.textContent = v; };
    const log = (m)=>{ const el=$("dbgLog"); el.textContent += m + "\\n"; };
    const pingEl = ()=> document.getElementById("ping");

    firebase.auth().onAuthStateChanged(u=>{
      set("dbgUid", u?u.uid:"ï¼ˆæœªç™»å…¥ï¼‰");
      document.getElementById("authHint").style.display = u ? "none" : "block";
    });

    // quick ping to verify connectivity & rules
    async function ping(){
      try{
        const s = await db.collection("profiles").doc("default").collection("settings").doc("base").get();
        if (s.exists){ pingEl().textContent = "å·²é€£ç·šï¼ˆsettings/base å­˜åœ¨ï¼‰"; pingEl().classList.remove("err"); }
        else { pingEl().textContent = "å·²é€£ç·šï¼Œä½† settings/base ä¸å­˜åœ¨ï¼ˆéå¿…è¦ï¼Œå¯å¿½ç•¥ï¼‰"; pingEl().classList.remove("err"); }
      }catch(e){
        pingEl().textContent = "é€£ç·š/æ¬Šé™éŒ¯èª¤ï¼š" + (e.message||e);
        pingEl().classList.add("err");
        log("ping éŒ¯èª¤ï¼š" + (e.message||e));
      }
    }

    function fmtMonthInput(ym){
      if (!ym) return "";
      const m = ym.match(/^(\\d{4})-(\\d{1,2})$/);
      if (!m) return "";
      const mm = String(parseInt(m[2],10)).padStart(2,"0");
      return m[1] + "-" + mm;
    }
    const ymFromDateStr = (s)=>{
      try{ const dt=new Date(s); if(!isNaN(dt)) return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0"); }catch(e){}
      const m=(s||"").match(/(\\d{4})[\\/\\-](\\d{1,2})/);
      if(m) return m[1]+"-"+String(parseInt(m[2],10)).padStart(2,"0");
      const now=new Date(); return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
    };

    let selYmA=null, selYmB=null, unsubA=null, unsubB=null, records=[];
    let viewMode="ab";
    const keyOf = (r)=> r._id ? ("id:"+r._id) : "ts:"+String(r.createdAt||"")+"|"+(r.name||"")+"|"+(r.price||"")+"|"+(r.weight||"")+"|"+(r.date||"");
    const dedup = (arr)=>{ const s=new Set(), out=[]; for(const r of arr||[]){ const k=keyOf(r); if(s.has(k)) continue; s.add(k); out.push(r);} return out; };

    function render(){
      const sumA = selYmA ? records.filter(r=> ymFromDateStr(r.date)===selYmA).reduce((s,r)=>s+(+r.bonus||0),0) : 0;
      const sumB = selYmB ? records.filter(r=> ymFromDateStr(r.date)===selYmB).reduce((s,r)=>s+(+r.bonus||0),0) : 0;
      set("sumA", Math.round(sumA)); set("sumB", Math.round(sumB));

      set("dbgYmA", selYmA || "â€”"); set("dbgYmB", selYmB || "â€”");
      set("dbgCntA", selYmA ? String(records.filter(r=> ymFromDateStr(r.date)===selYmA).length) : "0");
      set("dbgCntB", selYmB ? String(records.filter(r=> ymFromDateStr(r.date)===selYmB).length) : "0");

      let list = records;
      if (viewMode === "a" && selYmA) list = records.filter(r=> ymFromDateStr(r.date)===selYmA);
      if (viewMode === "b" && selYmB) list = records.filter(r=> ymFromDateStr(r.date)===selYmB);
      if (viewMode === "ab" && selYmA && selYmB) list = records.filter(r=> [selYmA, selYmB].includes(ymFromDateStr(r.date)));

      let out = (viewMode==="ab"?"ğŸ“˜ åˆä½µ A+Bï¼š":(viewMode==="a"?"ğŸ“˜ åƒ… Aï¼š":"ğŸ“˜ åƒ… Bï¼š"));
      out += list.length? "" : "\\nï¼ˆå°šç„¡ï¼‰";
      out += list.map((r,i)=>{
          const s = (r.date||""); const dateOnly = s.split(" ")[0] || s;
          return "\\n#" + (i+1) + " " + dateOnly + "ï½œ" + (r.name||"") + "ï½œ" + (r.product||"") + "ï½œ" + r.weight + "kgï½œå–®" + r.price + "ï½œçé‡‘" + r.bonus;
      }).join("");
      $("historyDisplay").textContent = out;
    }

    async function loadOneMonth(ym, onCount){
      try{
        const col = db.collection("profiles").doc("default").collection("months").doc(ym).collection("records").orderBy("createdAt","asc");
        const snap = await col.get();
        const arr = snap.docs.map(d=>Object.assign({_id:d.id}, d.data()));
        if (typeof onCount==='function') onCount(arr.length);
        return arr;
      }catch(e){
        log("è®€å– "+ym+" å¤±æ•—ï¼š" + (e.message||e));
        throw e;
      }
    }

    function rebindRealtime(){
      if (unsubA){ unsubA(); unsubA=null; }
      if (unsubB){ unsubB(); unsubB=null; }
      if (selYmA){
        const colA = db.collection("profiles").doc("default").collection("months").doc(selYmA).collection("records").orderBy("createdAt","asc");
        unsubA = colA.onSnapshot(s=>{
          const arrA = s.docs.map(d=>Object.assign({_id:d.id}, d.data()));
          records = dedup([...(selYmB? records.filter(r=> ymFromDateStr(r.date)!==selYmA):[]), ...arrA, ...(selYmB? records.filter(r=> ymFromDateStr(r.date)===selYmB):[])]);
          set("dbgCntA", String(arrA.length)); render();
          log("onSnapshot A è§¸ç™¼ï¼Œsize="+s.size);
        }, err=> log("onSnapshot A éŒ¯èª¤ï¼š"+(err.message||err)));
      }
      if (selYmB){
        const colB = db.collection("profiles").doc("default").collection("months").doc(selYmB).collection("records").orderBy("createdAt","asc");
        unsubB = colB.onSnapshot(s=>{
          const arrB = s.docs.map(d=>Object.assign({_id:d.id}, d.data()));
          records = dedup([...(selYmA? records.filter(r=> ymFromDateStr(r.date)!==selYmB):[]), ...arrB, ...(selYmA? records.filter(r=> ymFromDateStr(r.date)===selYmA):[])]);
          set("dbgCntB", String(arrB.length)); render();
          log("onSnapshot B è§¸ç™¼ï¼Œsize="+s.size);
        }, err=> log("onSnapshot B éŒ¯èª¤ï¼š"+(err.message||err)));
      }
    }

    async function loadSelectedMonths(){
      const a = fmtMonthInput($("#monthA").value.trim());
      const b = fmtMonthInput($("#monthB").value.trim());
      if (!a && !b){ alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½"); return; }
      selYmA = a || null; selYmB = b || null;
      set("dbgYmA", selYmA||"â€”"); set("dbgYmB", selYmB||"â€”");
      set("dbgCntA", "0"); set("dbgCntB", "0");
      records = [];
      $("historyDisplay").textContent = "è®€å–ä¸­â€¦";

      try{
        if (selYmA){ const arrA = await loadOneMonth(selYmA, c=>set("dbgCntA", String(c))); records = records.concat(arrA); }
        if (selYmB && selYmB!==selYmA){ const arrB = await loadOneMonth(selYmB, c=>set("dbgCntB", String(c))); records = records.concat(arrB); }
        records = dedup(records);
        render();
        rebindRealtime();
        log(`initialPull å®Œæˆï¼šA ${selYmA||"-"}ã€B ${selYmB||"-"}`);
      }catch(e){
        $("historyDisplay").textContent = "è®€å–å¤±æ•—ï¼š"+(e.message||e);
        log("è®€å–å¤±æ•—ï¼š"+(e.message||e));
      }
    }

    function quickPrevNow(){
      const now = new Date();
      const ymNow = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
      const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const ymPrev = prev.getFullYear()+"-"+String(prev.getMonth()+1).padStart(2,"0");
      $("#monthA").value = ymPrev;
      $("#monthB").value = ymNow;
      loadSelectedMonths();
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      set("dbgProject", FIREBASE_CONFIG.projectId);
      const now = new Date();
      const ymNow = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
      const prev = new Date(now.getFullYear(),now.getMonth()-1,1);
      const ymPrev = prev.getFullYear()+"-"+String(prev.getMonth()+1).padStart(2,"0");
      $("#monthA").value = ymPrev; $("#monthB").value = ymNow;

      $("#btnLoadMonths").onclick = loadSelectedMonths;
      $("#btnQuickNowPrev").onclick = quickPrevNow;
      $("#monthA").addEventListener("change", loadSelectedMonths);
      $("#monthB").addEventListener("change", loadSelectedMonths);

      // view buttons
      $("#viewA").onclick = ()=>{ viewMode="a"; $("#viewA").setAttribute("aria-pressed","true"); $("#viewAB").setAttribute("aria-pressed","false"); $("#viewB").setAttribute("aria-pressed","false"); render(); };
      $("#viewAB").onclick = ()=>{ viewMode="ab"; $("#viewA").setAttribute("aria-pressed","false"); $("#viewAB").setAttribute("aria-pressed","true"); $("#viewB").setAttribute("aria-pressed","false"); render(); };
      $("#viewB").onclick = ()=>{ viewMode="b"; $("#viewA").setAttribute("aria-pressed","false"); $("#viewAB").setAttribute("aria-pressed","false"); $("#viewB").setAttribute("aria-pressed","true"); render(); };

      // price
      const v0 = localStorage.getItem("basePrice"); if (v0){ document.getElementById("costPerKg").value = v0; document.getElementById("basePriceDisplay").textContent = String(Math.round(parseFloat(v0)||0)); }
      document.getElementById("costPerKg").addEventListener("input", ()=>{
        const v = document.getElementById("costPerKg").value; document.getElementById("basePriceDisplay").textContent = v ? String(Math.round(parseFloat(v)||0)) : "-"; localStorage.setItem("basePrice", v);
      });

      // initial actions
      ping();
      quickPrevNow();
    });
  </script>
</body>
</html>
