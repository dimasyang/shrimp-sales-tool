<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆv5fï½œè¨ºæ–·ç‰ˆï¼‰</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--bd:#d9dee8;--muted:#64748b;--brand:#4f8cff;--ok:#16a34a;--err:#dc2626}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;color:#1f2937}
    .container{max-width:1024px;margin:0 auto;padding:16px 16px 120px}
    h1{margin:0 0 8px}.lead{color:#374151;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
    input:not([type=checkbox]):not([type=radio]),button,a.btn{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    label span{display:block;font-size:12px;color:#475569;margin-bottom:6px}
    .btn{cursor:pointer;background:#f3f4f6;text-align:center;text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,#7aa2ff,#4f8cff);color:#fff;border:none;font-weight:600}
    .btn.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    .btn.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .seg{display:inline-grid;grid-auto-flow:column;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;padding:6px;border-radius:999px}
    .seg button{border:none;background:transparent;padding:6px 12px;border-radius:999px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:#4f46e5;color:#fff}
    .table{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px;margin-top:12px}
    pre{white-space:pre-wrap}
    .status{margin:8px 0;padding:10px;border-radius:10px;border:1px solid #cbd5e1;background:#eef2ff}
    .status.ok{border-color:#86efac;background:#eafff0}
    .status.err{border-color:#fecaca;background:#fff1f2}
    .dbg-footer{position:fixed;left:12px;bottom:12px;z-index:9999;background:rgba(17,24,39,.95);color:#e5e7eb;padding:10px 12px;border-radius:12px;border:1px solid #374151;max-width:90vw;font:12px ui-monospace,Menlo,Consolas,monospace}
    .dbg-footer .k{color:#93c5fd}.dbg-footer .v{color:#86efac}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
    <p class="lead">è¨ºæ–·ç‰ˆï¼šå¯ã€Œåªè¨ˆç®—ä¸å­˜ã€ã€æ¸…æ¥šé¡¯ç¤ºè®€å¯«éŒ¯èª¤èˆ‡ç‹€æ…‹ã€‚</p>

    <div id="statusBox" class="status">ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­â€¦</div>

    <section class="card">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <label><span>æœˆä»½ A</span><input id="monthA" type="month" /></label>
        <label><span>æœˆä»½ Bï¼ˆå¯ç•™ç©ºï¼‰</span><input id="monthB" type="month" /></label>
        <button class="btn primary" id="btnLoadMonths" style="width:auto;">è¼‰å…¥æ‰€é¸æœˆä»½</button>
        <button class="btn" id="btnQuickNowPrev" style="width:auto;">ä¸€éµè¼‰å…¥ï¼šæœ¬æœˆï¼‹ä¸Šæœˆ</button>
        <div class="seg" role="tablist">
          <button id="viewA" role="tab" aria-pressed="false">åƒ… A</button>
          <button id="viewAB" role="tab" aria-pressed="true">åˆä½µ A+B</button>
          <button id="viewB" role="tab" aria-pressed="false">åƒ… B</button>
        </div>
      </div>
      <div style="margin-top:8px;font-weight:600;color:#374151;">
        A æœˆï¼š<span id="sumA">0</span> å…ƒï½œB æœˆï¼š<span id="sumB">0</span> å…ƒ
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input id="salesName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>éŠ·å”®å“å</span><input id="productName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input id="actualWeight" type="number" placeholder="0" step="0.01"/></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input id="actualPrice" type="number" placeholder="0" step="0.01"/></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input id="costPerKg" type="number" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œå¯æ‰‹å‹•ä¿®æ”¹" step="0.01"/></label>
        <label><span>æ­¤ç­†ã€Œäº¤æ˜“æ—¥æœŸã€ï¼ˆæ±ºå®šæ­¸å±¬æœˆä»½ï¼‰</span><input id="recordDate" type="date"/></label>
      </div>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px">
        <button class="btn primary" id="btnCalcSave">è¨ˆç®—ä¸¦å„²å­˜</button>
        <button class="btn ok" id="btnCalcOnly">åªè¨ˆç®—ï¼ˆä¸å­˜ï¼‰</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <a class="btn" href="./index.html">è¿”å›ä¸»é </a>
      </div>

      <p class="em">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>

      <div class="table">
        <strong>ç´€éŒ„åˆ—è¡¨</strong>
        <pre id="historyDisplay"></pre>
      </div>
    </section>
  </div>

  <div class="dbg-footer" id="dbgFoot">
    <div><span class="k">projectId</span>: <span class="v" id="dbgProject">â€”</span> ï½œ <span class="k">UID</span>: <span class="v" id="dbgUid">â€”</span></div>
    <div><span class="k">A</span>: <span class="v" id="dbgYmA">â€”</span>ï¼ˆ<span class="k">count</span>: <span class="v" id="dbgCntA">0</span>ï¼‰ ï½œ <span class="k">B</span>: <span class="v" id="dbgYmB">â€”</span>ï¼ˆ<span class="k">count</span>: <span class="v" id="dbgCntB">0</span>ï¼‰</div>
    <div id="dbgLog" style="margin-top:6px;white-space:pre-wrap"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    firebase.auth().signInAnonymously().catch(()=>{});

    const $ = id=>document.getElementById(id);
    const set = (id, v)=>{ const el=$(id); if(el) el.textContent = v; };
    const log = (m)=>{ const el=$("dbgLog"); el.textContent += m + "\\n"; };
    const setStatus = (msg, ok=null)=>{
      const el = document.getElementById("statusBox"); el.textContent = "ç‹€æ…‹ï¼š" + msg;
      el.classList.remove("ok","err"); if(ok===true) el.classList.add("ok"); if(ok===false) el.classList.add("err");
    };

    firebase.auth().onAuthStateChanged(u=>{
      set("dbgUid", u?u.uid:"ï¼ˆæœªç™»å…¥ï¼‰");
      if(u){ setStatus("å·²ç™»å…¥ï¼ˆåŒ¿åï¼‰", true); } else { setStatus("æœªç™»å…¥", false); }
    });

    function fmtMonthInput(ym){ if(!ym) return ""; const m=ym.match(/^(\\d{4})-(\\d{1,2})$/); if(!m) return ""; return m[1]+"-"+String(parseInt(m[2],10)).padStart(2,"0"); }
    function ymFromDateInput(dateStr){ const m=(dateStr||"").match(/(\\d{4})[\\/\\-](\\d{1,2})/); return m? (m[1]+"-"+String(parseInt(m[2],10)).padStart(2,"0")) : ""; }

    let selYmA=null, selYmB=null, unsubA=null, unsubB=null, records=[];
    let viewMode="ab";
    const keyOf = (r)=> r._id ? ("id:"+r._id) : "ts:"+String(r.createdAt||"")+"|"+(r.name||"")+"|"+(r.price||"")+"|"+(r.weight||"")+"|"+(r.date||"");
    const dedup = (arr)=>{ const s=new Set(), out=[]; for(const r of arr||[]){ const k=keyOf(r); if(s.has(k)) continue; s.add(k); out.push(r);} return out; };

    function render(){
      const toYm = (r)=> ymFromDateInput((r.date||"").split(" ")[0]||r.date);
      const sumA = selYmA ? records.filter(r=> toYm(r)===selYmA).reduce((s,r)=>s+(+r.bonus||0),0) : 0;
      const sumB = selYmB ? records.filter(r=> toYm(r)===selYmB).reduce((s,r)=>s+(+r.bonus||0),0) : 0;
      set("sumA", Math.round(sumA)); set("sumB", Math.round(sumB));

      set("dbgYmA", selYmA || "â€”"); set("dbgYmB", selYmB || "â€”");
      set("dbgCntA", selYmA ? String(records.filter(r=> toYm(r)===selYmA).length) : "0");
      set("dbgCntB", selYmB ? String(records.filter(r=> toYm(r)===selYmB).length) : "0");

      let list = records;
      if (viewMode === "a" && selYmA) list = records.filter(r=> toYm(r)===selYmA);
      if (viewMode === "b" && selYmB) list = records.filter(r=> toYm(r)===selYmB);
      if (viewMode === "ab" && selYmA && selYmB) list = records.filter(r=> [selYmA, selYmB].includes(toYm(r)));

      let out = (viewMode==="ab"?"ğŸ“˜ åˆä½µ A+Bï¼š":(viewMode==="a"?"ğŸ“˜ åƒ… Aï¼š":"ğŸ“˜ åƒ… Bï¼š"));
      out += list.length? "" : "\\nï¼ˆå°šç„¡ï¼‰";
      out += list.map((r,i)=>{
          const s = (r.date||""); const dateOnly = s.split(" ")[0] || s;
          return "\\n#" + (i+1) + " " + dateOnly + "ï½œ" + (r.name||"") + "ï½œ" + (r.product||"") + "ï½œ" + r.weight + "kgï½œå–®" + r.price + "ï½œçé‡‘" + r.bonus;
      }).join("");
      $("historyDisplay").textContent = out;
    }

    async function loadOneMonth(ym, onCount){
      try{
        const col = db.collection("profiles").doc("default").collection("months").doc(ym).collection("records").orderBy("createdAt","asc");
        const snap = await col.get();
        const arr = snap.docs.map(d=>Object.assign({_id:d.id}, d.data()));
        if (typeof onCount==='function') onCount(arr.length);
        return arr;
      }catch(e){
        setStatus("è®€å– "+ym+" å¤±æ•—ï¼š"+(e.message||e), false);
        log("è®€å– "+ym+" å¤±æ•—ï¼š"+(e.message||e));
        throw e;
      }
    }

    function rebindRealtime(){
      if (unsubA){ unsubA(); unsubA=null; }
      if (unsubB){ unsubB(); unsubB=null; }
      const toYm = (r)=> ymFromDateInput((r.date||"").split(" ")[0]||r.date);
      if (selYmA){
        const colA = db.collection("profiles").doc("default").collection("months").doc(selYmA).collection("records").orderBy("createdAt","asc");
        unsubA = colA.onSnapshot(s=>{
          const arrA = s.docs.map(d=>Object.assign({_id:d.id}, d.data()));
          records = dedup([...(selYmB? records.filter(r=> toYm(r)!==selYmA):[]), ...arrA, ...(selYmB? records.filter(r=> toYm(r)===selYmB):[])]);
          set("dbgCntA", String(arrA.length)); render();
          log("onSnapshot A è§¸ç™¼ï¼Œsize="+s.size);
        }, err=> { setStatus("onSnapshot A éŒ¯èª¤ï¼š"+(err.message||err), false); log("onSnapshot A éŒ¯èª¤ï¼š"+(err.message||err)); });
      }
      if (selYmB){
        const colB = db.collection("profiles").doc("default").collection("months").doc(selYmB).collection("records").orderBy("createdAt","asc");
        unsubB = colB.onSnapshot(s=>{
          const arrB = s.docs.map(d=>Object.assign({_id:d.id}, d.data()));
          records = dedup([...(selYmA? records.filter(r=> toYm(r)!==selYmB):[]), ...arrB, ...(selYmA? records.filter(r=> toYm(r)===selYmA):[])]);
          set("dbgCntB", String(arrB.length)); render();
          log("onSnapshot B è§¸ç™¼ï¼Œsize="+s.size);
        }, err=> { setStatus("onSnapshot B éŒ¯èª¤ï¼š"+(err.message||err), false); log("onSnapshot B éŒ¯èª¤ï¼š"+(err.message||err)); });
      }
    }

    async function loadSelectedMonths(){
      const a = fmtMonthInput($("#monthA").value.trim());
      const b = fmtMonthInput($("#monthB").value.trim());
      if (!a && !b){ setStatus("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½", false); return; }
      selYmA = a || null; selYmB = b || null;
      set("dbgYmA", selYmA||"â€”"); set("dbgYmB", selYmB||"â€”");
      set("dbgCntA", "0"); set("dbgCntB", "0");
      records = [];
      $("historyDisplay").textContent = "è®€å–ä¸­â€¦";

      try{
        if (selYmA){ const arrA = await loadOneMonth(selYmA, c=>set("dbgCntA", String(c))); records = records.concat(arrA); }
        if (selYmB && selYmB!==selYmA){ const arrB = await loadOneMonth(selYmB, c=>set("dbgCntB", String(c))); records = records.concat(arrB); }
        records = dedup(records);
        render();
        rebindRealtime();
        setStatus("è¼‰å…¥å®Œæˆ", true);
      }catch(e){
        $("historyDisplay").textContent = "è®€å–å¤±æ•—ï¼š"+(e.message||e);
      }
    }

    function calcBonusLocal(){
      const cost = parseFloat($("#costPerKg").value||"");
      const actual = parseFloat($("#actualPrice").value||"");
      const weight = parseFloat($("#actualWeight").value||"");
      const dateInput = $("#recordDate").value;
      if (!dateInput) { setStatus("è«‹é¸æ“‡ã€äº¤æ˜“æ—¥æœŸã€", false); return null; }
      if (!isFinite(actual) || !isFinite(weight) || weight<=0) { setStatus("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤å–®åƒ¹èˆ‡é‡é‡", false); return null; }
      const bp = isFinite(cost) ? cost : (parseFloat(localStorage.getItem("basePrice")||"")||NaN);
      if (!isFinite(bp)) { setStatus("è«‹å…ˆè¼¸å…¥ã€æˆæœ¬(å…ƒ/kg)ã€", false); return null; }
      const deduct = 0, addSelf = 0, deductDriver = 0, addKHH = 0;
      const diff = actual - bp;
      const bonus = diff > 0 ? diff * weight - deduct - deductDriver + addSelf + addKHH : 0;
      $("#bonusResult").innerText = String(Math.round(bonus));
      return {bonus: Math.round(bonus), total: Math.round(actual*weight*100)/100, bp, actual, weight, dateInput};
    }

    function calcOnly(){ const r = calcBonusLocal(); if (r){ setStatus("åªè¨ˆç®—å®Œæˆï¼ˆæœªå¯«å…¥ï¼‰", true);} }

    function calcAndSave(){
      const r = calcBonusLocal(); if (!r) return;
      const ym = ymFromDateInput(r.dateInput);
      const dateStr = r.dateInput + " 00:00";
      const rec = {date:dateStr,name:$("#salesName").value.trim(),product:$("#productName").value.trim(),
                   weight:r.weight, price: r.actual, total: r.total, bonus: r.bonus, createdAt: Date.now()};

      db.collection("profiles").doc("default").collection("months").doc(ym).collection("records").add(rec)
        .then(()=>{ setStatus("å¯«å…¥æˆåŠŸ â†’ "+ym, true); log("å·²å¯«å…¥ "+ym); })
        .catch(e=>{ setStatus("å¯«å…¥å¤±æ•—ï¼š"+(e.message||e), false); log("å¯«å…¥å¤±æ•—ï¼š"+(e.message||e)); });

      const toYm = (x)=> ymFromDateInput((x.date||"").split(" ")[0]||x.date);
      if ((selYmA && ym===selYmA) || (selYmB && ym===selYmB)){
        records = dedup(records.concat([rec])); render();
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      set("dbgProject", FIREBASE_CONFIG.projectId);
      const today = new Date(); const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,"0"), dd=String(today.getDate()).padStart(2,"0");
      $("#recordDate").value = `${yyyy}-${mm}-${dd}`;

      const now = new Date(), ymNow = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
      const prev = new Date(now.getFullYear(),now.getMonth()-1,1), ymPrev = prev.getFullYear()+"-"+String(prev.getMonth()+1).padStart(2,"0");
      $("#monthA").value = ymPrev; $("#monthB").value = ymNow;

      $("#btnLoadMonths").onclick = loadSelectedMonths;
      $("#btnQuickNowPrev").onclick = ()=>{ $("#monthA").value = ymPrev; $("#monthB").value = ymNow; loadSelectedMonths(); };
      $("#viewA").onclick = ()=>{ viewMode="a"; $("#viewA").setAttribute("aria-pressed","true"); $("#viewAB").setAttribute("aria-pressed","false"); $("#viewB").setAttribute("aria-pressed","false"); render(); };
      $("#viewAB").onclick = ()=>{ viewMode="ab"; $("#viewA").setAttribute("aria-pressed","false"); $("#viewAB").setAttribute("aria-pressed","true"); $("#viewB").setAttribute("aria-pressed","false"); render(); };
      $("#viewB").onclick = ()=>{ viewMode="b"; $("#viewA").setAttribute("aria-pressed","false"); $("#viewAB").setAttribute("aria-pressed","false"); $("#viewB").setAttribute("aria-pressed","true"); render(); };

      $("#btnCalcOnly").onclick = calcOnly;
      $("#btnCalcSave").onclick = calcAndSave;

      $("#btnExport").onclick = ()=>{
        let list = records.slice();
        const toYm = (r)=> ymFromDateInput((r.date||"").split(" ")[0]||r.date);
        if (viewMode==="a" && selYmA) list = list.filter(r=> toYm(r)===selYmA);
        if (viewMode==="b" && selYmB) list = list.filter(r=> toYm(r)===selYmB);
        if (viewMode==="ab" && selYmA && selYmB) list = list.filter(r=> [selYmA, selYmB].includes(toYm(r)));
        let csv = "æ¥­å‹™å§“å,éŠ·å”®å“å,æ•¸é‡(kg),æˆäº¤å–®åƒ¹,ç¸½é‡‘é¡,çé‡‘,æ—¥æœŸ\n";
        list.forEach(r=> csv += `${r.name||""},${r.product||""},${r.weight},${r.price},${r.total||""},${r.bonus},${r.date}\n`);
        const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
        const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="æ¥­å‹™çé‡‘å ±è¡¨.csv"; a.click();
      };

      setStatus("å·²è¼‰å…¥é é¢ï¼Œè«‹å…ˆæŒ‰ã€ä¸€éµè¼‰å…¥ï¼šæœ¬æœˆï¼‹ä¸Šæœˆã€æˆ–è‡ªè¡Œé¸æœˆä»½å¾ŒæŒ‰ã€è¼‰å…¥æ‰€é¸æœˆä»½ã€", null);
    });
  </script>
</body>
</html>
