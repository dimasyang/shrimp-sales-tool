<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<script>var db;</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆv5eï½œä¾è¼¸å…¥æ—¥æœŸæ­¸æª”ï¼‰</title>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--bd:#ddd;--muted:#666;--brand:#4f8cff;--brand2:#7aa2ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;color:#222}
    .container{max-width:1000px;margin:0 auto;padding:16px 16px 120px}
    h1{margin:0 0 8px}.lead{color:#374151;margin:0 0 8px}
    small.hint{color:#6b7280}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
    input:not([type=checkbox]):not([type=radio]),button,a.btn,select{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    label span{display:block;font-size:12px;color:#475569;margin-bottom:6px}
    .btn{cursor:pointer;background:#f3f4f6;text-align:center;text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#fff;border:none;font-weight:600}
    .btn.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    .btn.danger{background:#fde2e2;border-color:#f5c2c7;color:#842029}
    .actions{display:grid;gap:10px;grid-template-columns:1fr 1fr} @media(min-width:640px){.actions{grid-template-columns:repeat(4,1fr)}}
    .table{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px;margin-top:12px}
    pre{white-space:pre-wrap}
    .seg{display:inline-grid;grid-auto-flow:column;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;padding:6px;border-radius:999px}
    .seg button{border:none;background:transparent;padding:6px 12px;border-radius:999px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:#4f46e5;color:#fff}
    .dbg-footer{position:fixed;left:12px;bottom:12px;z-index:9999;background:rgba(17,24,39,.95);color:#e5e7eb;padding:10px 12px;border-radius:12px;border:1px solid #374151;max-width:90vw;font:12px ui-monospace,Menlo,Consolas,monospace}
    .dbg-footer .k{color:#93c5fd}.dbg-footer .v{color:#86efac}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mini{font-size:12px;color:#6b7280}
    .err{color:#b91c1c;font-weight:600}
  </style>

<!-- Firebase SDK (compat) + config (v7) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
    authDomain: "sales-bonusrecord.firebaseapp.com",
    projectId: "sales-bonusrecord",
    storageBucket: "sales-bonusrecord.firebasestorage.app",
    messagingSenderId: "679798751240",
    appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
    measurementId: "G-WFSZG479WS"
  };
  if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
</script>

</head>
<body>

<!-- v7a hidden anchors for legacy scripts -->
<div id="legacy-month-anchors" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden;">
  <input type="text" id="monthA" value="" />
  <input type="text" id="monthB" value="" />
</div>

  <div class="container">
    <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
    <p class="lead">ä¾ã€Œè¼¸å…¥æ—¥æœŸã€æ­¸æª”åˆ°å°æ‡‰æœˆä»½ï¼›æ”¯æ´å…©å€‹æœˆä»½è¼‰å…¥ã€åˆä½µ/å–®æœˆæª¢è¦–ã€CSV åŒ¯å‡ºã€‚</p>

    <!-- æœˆä»½æ§åˆ¶ -->
    <section class="card">
      <div class="row">
        <label><span>æœˆä»½ A</span><input id="monthA" type="month" /></label>
        <label><span>æœˆä»½ Bï¼ˆå¯ç•™ç©ºï¼‰</span><input id="monthB" type="month" /></label>
        <button class="btn primary" id="btnLoadMonths" style="width:auto;">è¼‰å…¥æ‰€é¸æœˆä»½</button>
        <button class="btn" id="btnQuickNowPrev" style="width:auto;">ä¸€éµè¼‰å…¥ï¼šæœ¬æœˆï¼‹ä¸Šæœˆ</button>
        <div class="seg" role="tablist">
          <button id="viewA" role="tab" aria-pressed="false">åƒ… A</button>
          <button id="viewAB" role="tab" aria-pressed="true">åˆä½µ A+B</button>
          <button id="viewB" role="tab" aria-pressed="false">åƒ… B</button>
        </div>
      </div>
      <div class="mini"><strong>ç‹€æ…‹ï¼š</strong><span id="ping" class="err"></span></div>
      <div style="margin-top:8px;font-weight:600;color:#374151;">
        A æœˆï¼š<span id="sumA">0</span> å…ƒï½œB æœˆï¼š<span id="sumB">0</span> å…ƒ
      </div>
    </section>

    <!-- äº¤æ˜“è¼¸å…¥ -->
    <section class="card" style="margin-top:12px">
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input id="salesName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>éŠ·å”®å“å</span><input id="productName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input id="actualWeight" type="number" placeholder="0" step="0.01"/></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input id="actualPrice" type="number" placeholder="0" step="0.01"/></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input id="costPerKg" type="number" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œå¯æ‰‹å‹•ä¿®æ”¹" step="0.01"/></label>
        <label><span>æ­¤ç­†ã€Œäº¤æ˜“æ—¥æœŸã€ï¼ˆæ±ºå®šæ­¸å±¬æœˆä»½ï¼‰</span><input id="recordDate" type="date"/></label>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <label><input type="checkbox" id="homeDelivery"/> å®…é…ï¼ˆæ‰£250å…ƒï¼‰</label>
        <label><input type="checkbox" id="selfDelivery"/> è‡ªè¡Œé…é€ï¼ˆæ¯å…¬æ–¤åŠ 3å…ƒï¼‰</label>
        <label><input type="checkbox" id="companyDriver"/> å…¬å¸å¸æ©Ÿï¼ˆæ¯å…¬æ–¤æ‰£3å…ƒï¼‰</label>
        <label><input type="checkbox" id="kaohsiungLocal"/> é«˜é›„å¸‚å€å…¬å¸è»Šï¼ˆæ•´ç­† +5 å…ƒï¼‰</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—ä¸¦å„²å­˜</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <a class="btn primary" href="./index.html">è¿”å›ä¸»é </a>
        <button class="btn danger" id="btnDelPicked">åˆªé™¤é¸å–ç´€éŒ„ï¼ˆä¹‹å¾Œæä¾›ï¼‰</button>
      </div>

      <p class="em">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>

      <div class="table">
        <strong>ç´€éŒ„åˆ—è¡¨</strong>
        <pre id="historyDisplay"></pre>
      </div>
    </section>
  </div>

  <!-- Debug footer -->
  <div class="dbg-footer" id="dbgFoot">
    <div><span class="k">projectId</span>: <span class="v" id="dbgProject">â€”</span> ï½œ <span class="k">UID</span>: <span class="v" id="dbgUid">â€”</span></div>
    <div><span class="k">A</span>: <span class="v" id="dbgYmA">â€”</span>ï¼ˆ<span class="k">count</span>: <span class="v" id="dbgCntA">0</span>ï¼‰ ï½œ <span class="k">B</span>: <span class="v" id="dbgYmB">â€”</span>ï¼ˆ<span class="k">count</span>: <span class="v" id="dbgCntB">0</span>ï¼‰</div>
    <div id="dbgLog" style="margin-top:6px;white-space:pre-wrap"></div>
  </div>
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    try { db.enablePersistence({synchronizeTabs:true}); } catch(e){}
    firebase.auth().signInAnonymously().catch(()=>{});

    const $ = id=>document.getElementById(id);
    const set = (id, v)=>{ const el=$(id); if(el) el.textContent = v; };
    const log = (m)=>{ const el=$("dbgLog"); el.textContent += m + "\\n"; };
    const pingEl = ()=> document.getElementById("ping");

    firebase.auth().onAuthStateChanged(u=>{
      set("dbgUid", u?u.uid:"ï¼ˆæœªç™»å…¥ï¼‰");
    });

    // quick ping to verify connectivity
    async function ping(){
      try{
        await db.collection("profiles").doc("default").get();
        pingEl().textContent = "å·²é€£ç·š";
        pingEl().classList.remove("err");
      }catch(e){
        pingEl().textContent = "é€£ç·š/æ¬Šé™éŒ¯èª¤ï¼š" + (e.message||e);
        pingEl().classList.add("err");
        log("ping éŒ¯èª¤ï¼š" + (e.message||e));
      }
    }

    // helpers
    function fmtMonthInput(ym){
      if (!ym) return "";
      const m = ym.match(/^(\\d{4})-(\\d{1,2})$/);
      if (!m) return "";
      const mm = String(parseInt(m[2],10)).padStart(2,"0");
      return m[1] + "-" + mm;
    }
    function ymFromDateInput(dateStr){
      // expects YYYY-MM-DD; tolerant to YYYY/M/D
      if(!dateStr) return "";
      const m = dateStr.match(/(\\d{4})[\\/\\-](\\d{1,2})/);
      if(!m) return "";
      return m[1]+"-"+String(parseInt(m[2],10)).padStart(2,"0");
    }

    let selYmA=null, selYmB=null, unsubA=null, unsubB=null, records=[];
    let viewMode="ab";
    const keyOf = (r)=> r._id ? ("id:"+r._id) : "ts:"+String(r.createdAt||"")+"|"+(r.name||"")+"|"+(r.price||"")+"|"+(r.weight||"")+"|"+(r.date||"");
    const dedup = (arr)=>{ const s=new Set(), out=[]; for(const r of arr||[]){ const k=keyOf(r); if(s.has(k)) continue; s.add(k); out.push(r);} return out; };

    function render(){
      const toYm = (r)=> ymFromDateInput(r.date?.split(' ')[0]||r.date);
      const sumA = selYmA ? records.filter(r=> toYm(r)===selYmA).reduce((s,r)=>s+(+r.bonus||0),0) : 0;
      const sumB = selYmB ? records.filter(r=> toYm(r)===selYmB).reduce((s,r)=>s+(+r.bonus||0),0) : 0;
      set("sumA", Math.round(sumA)); set("sumB", Math.round(sumB));

      set("dbgYmA", selYmA || "â€”"); set("dbgYmB", selYmB || "â€”");
      set("dbgCntA", selYmA ? String(records.filter(r=> toYm(r)===selYmA).length) : "0");
      set("dbgCntB", selYmB ? String(records.filter(r=> toYm(r)===selYmB).length) : "0");

      let list = records;
      if (viewMode === "a" && selYmA) list = records.filter(r=> toYm(r)===selYmA);
      if (viewMode === "b" && selYmB) list = records.filter(r=> toYm(r)===selYmB);
      if (viewMode === "ab" && selYmA && selYmB) list = records.filter(r=> [selYmA, selYmB].includes(toYm(r)));

      let out = (viewMode==="ab"?"ğŸ“˜ åˆä½µ A+Bï¼š":(viewMode==="a"?"ğŸ“˜ åƒ… Aï¼š":"ğŸ“˜ åƒ… Bï¼š"));
      out += list.length? "" : "\\nï¼ˆå°šç„¡ï¼‰";
      out += list.map((r,i)=>{
          const s = (r.date||""); const dateOnly = s.split(" ")[0] || s;
          return "\\n#" + (i+1) + " " + dateOnly + "ï½œ" + (r.name||"") + "ï½œ" + (r.product||"") + "ï½œ" + r.weight + "kgï½œå–®" + r.price + "ï½œçé‡‘" + r.bonus;
      }).join("");
      $("historyDisplay").textContent = out;
    }

    async function loadOneMonth(ym, onCount){
      try{
        const col = db.collection("profiles").doc("default").collection("months").doc(ym).collection("records").orderBy("createdAt","asc");
        const snap = await col.get();
        const arr = snap.docs.map(d=>Object.assign({_id:d.id}, d.data()));
        if (typeof onCount==='function') onCount(arr.length);
        return arr;
      }catch(e){
        log("è®€å– "+ym+" å¤±æ•—ï¼š" + (e.message||e));
        throw e;
      }
    }

    function rebindRealtime(){
      if (unsubA){ unsubA(); unsubA=null; }
      if (unsubB){ unsubB(); unsubB=null; }
      const toYm = (r)=> ymFromDateInput(r.date?.split(' ')[0]||r.date);
      if (selYmA){
        const colA = db.collection("profiles").doc("default").collection("months").doc(selYmA).collection("records").orderBy("createdAt","asc");
        unsubA = colA.onSnapshot(s=>{
          const arrA = s.docs.map(d=>Object.assign({_id:d.id}, d.data()));
          records = dedup([...(selYmB? records.filter(r=> toYm(r)!==selYmA):[]), ...arrA, ...(selYmB? records.filter(r=> toYm(r)===selYmB):[])]);
          set("dbgCntA", String(arrA.length)); render();
          log("onSnapshot A è§¸ç™¼ï¼Œsize="+s.size);
        }, err=> log("onSnapshot A éŒ¯èª¤ï¼š"+(err.message||err)));
      }
      if (selYmB){
        const colB = db.collection("profiles").doc("default").collection("months").doc(selYmB).collection("records").orderBy("createdAt","asc");
        unsubB = colB.onSnapshot(s=>{
          const arrB = s.docs.map(d=>Object.assign({_id:d.id}, d.data()));
          records = dedup([...(selYmA? records.filter(r=> toYm(r)!==selYmB):[]), ...arrB, ...(selYmA? records.filter(r=> toYm(r)===selYmA):[])]);
          set("dbgCntB", String(arrB.length)); render();
          log("onSnapshot B è§¸ç™¼ï¼Œsize="+s.size);
        }, err=> log("onSnapshot B éŒ¯èª¤ï¼š"+(err.message||err)));
      }
    }

    async function loadSelectedMonths(){
      const a = fmtMonthInput($("#monthA").value.trim());
      const b = fmtMonthInput($("#monthB").value.trim());
      if (!a && !b){ alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½"); return; }
      selYmA = a || null; selYmB = b || null;
      set("dbgYmA", selYmA||"â€”"); set("dbgYmB", selYmB||"â€”");
      set("dbgCntA", "0"); set("dbgCntB", "0");
      records = [];
      $("historyDisplay").textContent = "è®€å–ä¸­â€¦";

      try{
        if (selYmA){ const arrA = await loadOneMonth(selYmA, c=>set("dbgCntA", String(c))); records = records.concat(arrA); }
        if (selYmB && selYmB!==selYmA){ const arrB = await loadOneMonth(selYmB, c=>set("dbgCntB", String(c))); records = records.concat(arrB); }
        records = dedup(records);
        render();
        rebindRealtime();
        log(`initialPull å®Œæˆï¼šA ${selYmA||"-"}ã€B ${selYmB||"-"}`);
      }catch(e){
        $("historyDisplay").textContent = "è®€å–å¤±æ•—ï¼š"+(e.message||e);
        log("è®€å–å¤±æ•—ï¼š"+(e.message||e));
      }
    }

    function quickPrevNow(){
      const now = new Date();
      const ymNow = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
      const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const ymPrev = prev.getFullYear()+"-"+String(prev.getMonth()+1).padStart(2,"0");
      $("#monthA").value = ymPrev;
      $("#monthB").value = ymNow;
      loadSelectedMonths();
    }

    function calculateAndSave(){
      const cost = parseFloat($("#costPerKg").value||"");
      const actual = parseFloat($("#actualPrice").value||"");
      const weight = parseFloat($("#actualWeight").value||"");
      const dateInput = $("#recordDate").value; // YYYY-MM-DD
      if (!dateInput) return alert("è«‹é¸æ“‡ã€æ­¤ç­†äº¤æ˜“æ—¥æœŸã€ï¼Œç”¨ä»¥æ±ºå®šæ­¸å±¬æœˆä»½");
      if (!isFinite(actual) || !isFinite(weight) || weight<=0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤å–®åƒ¹èˆ‡é‡é‡");
      const bp = isFinite(cost) ? cost : (parseFloat(localStorage.getItem("basePrice")||"")||NaN);
      if (!isFinite(bp)) return alert("è«‹å…ˆè¼¸å…¥ã€æˆæœ¬(å…ƒ/kg)ã€");
      const deduct = $("#homeDelivery").checked ? 250 : 0;
      const addSelf = $("#selfDelivery").checked ? weight * 3 : 0;
      const deductDriver = $("#companyDriver").checked ? weight * 3 : 0;
      const addKHH = $("#kaohsiungLocal").checked ? 5 : 0;
      const diff = actual - bp;
      const bonus = diff > 0 ? diff * weight - deduct - deductDriver + addSelf + addKHH : 0;
      $("#bonusResult").innerText = String(Math.round(bonus));

      // ä»¥è¼¸å…¥æ—¥æœŸæ±ºå®š LM (YYYY-MM)
      const ym = ymFromDateInput(dateInput);
      if (!ym) return alert("æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡");
      // å„²å­˜çš„ date æ¬„ä½åŠ ä¸Šæ™‚é–“ 00:00
      const dateStr = dateInput + " 00:00";

      const rec = {date:dateStr,name:$("#salesName").value.trim(),product:$("#productName").value.trim(),
                   weight, price: actual, total: Math.round(actual*weight*100)/100, bonus: Math.round(bonus), createdAt: Date.now()};

      db.collection("profiles").doc("default").collection("months").doc(ym).collection("records").add(rec)
        .then(()=>{ log("å·²å¯«å…¥ "+ym); })
        .catch(e=>{ log("å¯«å…¥å¤±æ•—ï¼š"+(e.message||e)); alert("å¯«å…¥å¤±æ•—ï¼š"+(e.message||e)); });

      // è‹¥æ­£å¥½åœ¨æª¢è¦–åŒæœˆä»½ï¼Œå…ˆæœ¬åœ°åŠ å…¥ä¸€ç­†ï¼ˆç­‰ onSnapshot ä¹Ÿæœƒè£œæ­£ï¼‰
      const toYm = (r)=> ymFromDateInput(r.date?.split(' ')[0]||r.date);
      if ((selYmA && ym===selYmA) || (selYmB && ym===selYmB)){
        records = dedup(records.concat([rec]));
        render();
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      set("dbgProject", FIREBASE_CONFIG.projectId);
      // default: ä»Šæ—¥æ—¥æœŸå¸¶å…¥ recordDate
      const today = new Date();
      const yyyy = today.getFullYear(), mm = String(today.getMonth()+1).padStart(2,"0"), dd = String(today.getDate()).padStart(2,"0");
      $("#recordDate").value = `${yyyy}-${mm}-${dd}`;

      const now = new Date();
      const ymNow = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
      const prev = new Date(now.getFullYear(),now.getMonth()-1,1);
      const ymPrev = prev.getFullYear()+"-"+String(prev.getMonth()+1).padStart(2,"0");
      $("#monthA").value = ymPrev; $("#monthB").value = ymNow;

      $("#btnLoadMonths").onclick = loadSelectedMonths;
      $("#btnQuickNowPrev").onclick = quickPrevNow;
      $("#monthA").addEventListener("change", loadSelectedMonths);
      $("#monthB").addEventListener("change", loadSelectedMonths);

      // view buttons
      $("#viewA").onclick = ()=>{ viewMode="a"; $("#viewA").setAttribute("aria-pressed","true"); $("#viewAB").setAttribute("aria-pressed","false"); $("#viewB").setAttribute("aria-pressed","false"); render(); };
      $("#viewAB").onclick = ()=>{ viewMode="ab"; $("#viewA").setAttribute("aria-pressed","false"); $("#viewAB").setAttribute("aria-pressed","true"); $("#viewB").setAttribute("aria-pressed","false"); render(); };
      $("#viewB").onclick = ()=>{ viewMode="b"; $("#viewA").setAttribute("aria-pressed","false"); $("#viewAB").setAttribute("aria-pressed","false"); $("#viewB").setAttribute("aria-pressed","true"); render(); };

      // price
      const v0 = localStorage.getItem("basePrice"); if (v0){ document.getElementById("costPerKg").value = v0; (document.getElementById("basePriceDisplay")||{textContent:null}).textContent = String(Math.round(parseFloat(v0)||0)); }
      document.getElementById("costPerKg").addEventListener("input", ()=>{
        const v = document.getElementById("costPerKg").value; (document.getElementById("basePriceDisplay")||{textContent:null}).textContent = v ? String(Math.round(parseFloat(v)||0)) : "-"; localStorage.setItem("basePrice", v);
      });

      ping();
      // é¦–æ¬¡è‡ªå‹•è¼‰å…¥ä¸Šæœˆ+æœ¬æœˆ
      quickPrevNow();

      // ç¶å®šè¨ˆç®—/å„²å­˜
      $("#btnCalc").onclick = calculateAndSave;
      // åŒ¯å‡º
      $("#btnExport").onclick = ()=>{
        let list = records.slice();
        const toYm = (r)=> ymFromDateInput(r.date?.split(' ')[0]||r.date);
        if (viewMode==="a" && selYmA) list = list.filter(r=> toYm(r)===selYmA);
        if (viewMode==="b" && selYmB) list = list.filter(r=> toYm(r)===selYmB);
        if (viewMode==="ab" && selYmA && selYmB) list = list.filter(r=> [selYmA, selYmB].includes(toYm(r)));
        let csv = "æ¥­å‹™å§“å,éŠ·å”®å“å,æ•¸é‡(kg),æˆäº¤å–®åƒ¹,ç¸½é‡‘é¡,çé‡‘,æ—¥æœŸ\n";
        list.forEach(r=> csv += `${r.name||""},${r.product||""},${r.weight},${r.price},${r.total||""},${r.bonus},${r.date}\n`);
        const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
        const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="æ¥­å‹™çé‡‘å ±è¡¨.csv"; a.click();
      };

      // åˆªé™¤ï¼ˆä½”ä½ï¼‰
      $("#btnDelPicked").onclick = ()=> alert("æ‰¹æ¬¡åˆªé™¤å°‡æ–¼ä¸‹ä¸€ç‰ˆæä¾›ï¼ˆé¿å…è·¨æœˆèª¤åˆªï¼‰ã€‚");
    });
  </script>

<!-- v7 robust month loader + safe overrides -->
<script>
(function(){
  function logDbg(msg){
    try{
      const box = document.getElementById("debugBox") || document.createElement("div");
      if(!box.id){
        box.id="debugBox";
        box.style="position:fixed;right:8px;bottom:8px;background:#111;color:#0f0;padding:8px 10px;border-radius:6px;font:12px/1.4 monospace;max-width:48vw;z-index:9999;opacity:.95";
        document.body.appendChild(box);
      }
      const p = document.createElement("div"); p.textContent = msg; box.appendChild(p);
      console.log("[bonus v7]", msg);
    }catch(e){}
  }
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function ensureDb(){
    let tries=0;
    while(!(window.firebase) && tries<200){ await wait(50); tries++; }
    if (!firebase) throw new Error("Firebase SDK not loaded");
    if (!window.db) window.db = firebase.firestore();
    return window.db;
  }
  function normYM(s){
    const m = String(s||'').match(/(\d{4}).*?(\d{1,2})/);
    return m ? (m[1] + "-" + String(m[2]).padStart(2,'0')) : null;
  }
  function detectMonthInputs(){
    // ä¾ç‰ˆé¢å¯¬åº¦ç”±å·¦åˆ°å³æ‰¾å…©å€‹åƒæœˆä»½çš„è¼¸å…¥
    const list = Array.from(document.querySelectorAll('input, .flatpickr-input'));
    const cands = list.filter(el => /å¹´|æœˆ|\d{4}[-/]\d{1,2}/.test((el.value||el.placeholder||'')));
    cands.sort((a,b)=>a.getBoundingClientRect().left - b.getBoundingClientRect().left);
    return [cands[0] || null, cands[1] || null];
  }
  function getYMFromInputs(index){
    const [a,b] = detectMonthInputs();
    const el = index===0 ? a : b;
    return normYM(el ? (el.value || el.getAttribute('value') || el.placeholder || '') : '');
  }
  async function readMonthCount(ym){
    if(!ym) return 0;
    const d = await ensureDb();
    const snap = await d.collection('profiles').doc('default').collection('months').doc(ym).collection('records').get();
    return snap.size||0;
  }
  async function fallbackLoadSelected(){
    try{
      const A = getYMFromInputs(0);
      const B = getYMFromInputs(1);
      const [ca, cb] = await Promise.all([readMonthCount(A), readMonthCount(B)]);
      logDbg("fallback A("+ (A||'-') +")="+ca+" B("+ (B||'-') +")="+cb);
      const stat = document.querySelector('[data-role="statusAB"]') || document.createElement('div');
      stat.dataset.role = "statusAB";
      stat.style = "position:fixed;left:8px;top:8px;background:#005;padding:6px 8px;color:#fff;border-radius:6px;font:12px monospace;z-index:9999;opacity:.9";
      stat.textContent = "A("+ (A||'-') +")="+ca+"ï¼›B("+ (B||'-') +")="+cb;
      if(!stat.parentNode) document.body.appendChild(stat);
    }catch(e){
      alert("è¼‰å…¥æœˆä»½è³‡æ–™å¤±æ•—ï¼š\n"+e.message);
      console.error(e);
    }
  }
  // ä¿å­˜åŸå‡½å¼
  const _origLoad = window.loadSelectedMonths;
  const _origQuick = window.quickPrevNow;
  // è¦†å¯«ç‚ºä¿åº•ç‰ˆæœ¬
  window.loadSelectedMonths = async function(){
    try{
      if (typeof _origLoad === 'function'){
        await _origLoad();
      }else{
        await fallbackLoadSelected();
      }
    }catch(e){
      logDbg("orig loadSelectedMonths failed: "+e.message);
      await fallbackLoadSelected();
    }
  };
  window.quickPrevNow = async function(){
    try{
      if (typeof _origQuick === 'function'){
        await _origQuick();
        return;
      }
    }catch(e){ logDbg("orig quickPrevNow failed: "+e.message); }
    // è‹¥æ²’æœ‰åŸå‡½å¼ï¼šä»¥ä»Šå¤©è‡ªå‹•åˆ¤å®šæœ¬æœˆ/ä¸Šæœˆç›´æ¥è®€ç­†æ•¸
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const thisYM = y + "-" + String(m).padStart(2,'0');
    const pm = (m===1) ? 12 : (m-1);
    const py = (m===1) ? (y-1) : y;
    const prevYM = py + "-" + String(pm).padStart(2,'0');
    const [ca, cb] = await Promise.all([readMonthCount(thisYM), readMonthCount(prevYM)]);
    logDbg("quickPrevNow fallback A("+thisYM+")="+ca+" B("+prevYM+")="+cb);
    const stat = document.querySelector('[data-role="statusAB"]') || document.createElement('div');
    stat.dataset.role = "statusAB";
    stat.style = "position:fixed;left:8px;top:8px;background:#005;padding:6px 8px;color:#fff;border-radius:6px;font:12px monospace;z-index:9999;opacity:.9";
    stat.textContent = "A("+ thisYM +")="+ca+"ï¼›B("+ prevYM +")="+cb;
    if(!stat.parentNode) document.body.appendChild(stat);
  };
  // ç¶å®šæŒ‰éˆ•
  function bindButtons(){
    const btns = Array.from(document.querySelectorAll('button,input[type="button"]'));
    btns.forEach(btn=>{
      const t = (btn.textContent||btn.value||'').trim();
      if(/è¼‰å…¥æ‰€é¸æœˆä»½/.test(t)){
        btn.addEventListener('click', ()=>window.loadSelectedMonths());
      }
      if(/ä¸€éµè¼‰å…¥/.test(t) || /æœ¬æœˆï¼‹ä¸Šæœˆ/.test(t)){
        btn.addEventListener('click', ()=>window.quickPrevNow());
      }
    });
    logDbg("buttons bound ("+btns.length+")");
  }
  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      await ensureDb();
      bindButtons();
      if (firebase && firebase.auth){
        firebase.auth().onAuthStateChanged(async function(u){
          logDbg("auth state: "+(u?u.uid:'no user'));
          if (!u){
            try{ await firebase.auth().signInAnonymously(); }catch(e){ logDbg("signIn error: "+e.message); }
          }else{
            // è‡ªå‹•è·‘ä¸€æ¬¡å¿«è¼‰
            try{ await window.quickPrevNow(); }catch(e){}
          }
        });
      }
      // é¡¯ç¤º projectId
      try{
        const pid = firebase.app().options.projectId || '-';
        logDbg("projectId="+pid);
      }catch(e){}
    }catch(e){
      logDbg("init error: "+e.message);
    }
  });
})();
</script>


<!-- v7a sync visible months to hidden #monthA/#monthB and add test-write -->
<script>
(function(){
  function normYM(s){
    var m = String(s||'').match(/(\d{4}).*?(\d{1,2})/);
    return m ? (m[1] + "-" + String(m[2]).padStart(2,'0')) : "";
  }
  function detectMonthInputs(){
    var list = Array.prototype.slice.call(document.querySelectorAll('input, .flatpickr-input'));
    var cands = list.filter(function(el){ return /(å¹´|æœˆ|\d{4}[-/]\d{1,2})/.test((el.value||el.placeholder||'')); });
    cands.sort(function(a,b){ return a.getBoundingClientRect().left - b.getBoundingClientRect().left; });
    return [cands[0]||null, cands[1]||null];
  }
  function syncHidden(){
    try{
      var a = document.getElementById('monthA');
      var b = document.getElementById('monthB');
      var vis = detectMonthInputs();
      var va = vis[0] ? (vis[0].value || vis[0].placeholder || '') : '';
      var vb = vis[1] ? (vis[1].value || vis[1].placeholder || '') : '';
      if (a) a.value = normYM(va);
      if (b) b.value = normYM(vb);
    }catch(e){}
  }
  document.addEventListener('input', function(e){ if(e.target && (e.target.matches('input')||e.target.classList.contains('flatpickr-input'))) syncHidden(); }, true);
  document.addEventListener('change', function(){ syncHidden(); }, true);
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(syncHidden, 600); });
})();
</script>


<!-- v7a: floating test-write button -->
<div id="testWriteBtn" style="position:fixed;right:12px;bottom:12px;padding:8px 10px;background:#0a0;color:#fff;border-radius:8px;font:12px/1.2 sans-serif;cursor:pointer;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,.2)">ä¸€éµæ¸¬è©¦å¯«å…¥</div>
<script>
(function(){
  async function testWrite(){
    try{
      const db = (window.db || firebase.firestore());
      const now = new Date();
      const ym = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,'0');
      const ref = db.collection('profiles').doc('default').collection('months').doc(ym).collection('records');
      const payload = {
        createdAt: Date.now(),
        note: 'TEST-WRITE from v7a',
        qty: 1,
        pricePerKg: 0,
        seller: 'TEST'
      };
      const docRef = await ref.add(payload);
      alert('å¯«å…¥æˆåŠŸï¼š' + ym + ' / ' + docRef.id);
    }catch(e){
      alert('å¯«å…¥å¤±æ•—ï¼š' + e.message);
      console.error(e);
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('testWriteBtn');
    if (btn) btn.addEventListener('click', testWrite);
  });
})();
</script>

</body>
</html>
