<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ¥­å‹™çé‡‘è¨ˆç®—ï¼ˆRWD æ·ºè‰²ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --muted:#555;
      --text:#222;
      --brand:#4f8cff;
      --brand-2:#7aa2ff;
      --danger:#d9534f;
      --ok:#32d296;
      --bd:#ccc;
      --radius:12px;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container{ max-width:1000px; margin:0 auto; padding: max(env(safe-area-inset-top), 16px) 16px calc(88px + env(safe-area-inset-bottom)); }
    h1{ font-size: clamp(20px, 3.5vw, 28px); margin:0 0 12px; }
    p.lead{ color:var(--muted); margin:0 0 18px; }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:var(--radius); padding:16px; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:640px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width:960px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    label span{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, button{ width:100%; padding:10px; border-radius:8px; border:1px solid var(--bd); background:#fff; color:#222; }
    .btn{ cursor:pointer; border:1px solid var(--bd); background:#f0f0f0; }
    .btn.primary{ background:linear-gradient(180deg, var(--brand-2), var(--brand)); border:none; color:#fff; font-weight:600; }
    .btn.ok{ background:#d4edda; border-color:#c3e6cb; color:#155724; }
    .btn.danger{ background:#f8d7da; border-color:#f5c6cb; color:#a94442; }
    .actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    @media (min-width:640px){ .actions{ grid-template-columns: repeat(4, 1fr); } }
    .highlight{ font-weight:700; color:#b00020; }
    .notice{ font-size:12px; color:var(--muted); }
    .table{ background:#fff; border:1px solid var(--bd); border-radius:8px; padding:12px; margin-top:12px; }
    .dock{
      position:fixed; left:0; right:0; bottom:0; backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.9); border-top:1px solid var(--bd);
      padding:10px 12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    @media (min-width:640px){ .dock{ grid-template-columns: repeat(4, 1fr); } }
    pre{ white-space: pre-wrap; background:#fafafa; border:1px solid var(--bd); border-radius:8px; padding:10px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
      <p class="lead">è®€å–ä¸»é åº•åƒ¹ï¼ˆlocalStorageï¼‰ï½œæ¯ç­†çé‡‘è¨˜éŒ„æœ¬æœˆï¼Œè·¨æœˆè‡ªå‹•æ­¸æª”</p>
    </header>

    <section class="card">
      <p>æ¯å…¬æ–¤åº•åƒ¹ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š<span id="basePriceDisplay" class="highlight">-</span> å…ƒ</p>
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input type="text" id="salesName" placeholder="è«‹è¼¸å…¥æ¥­å‹™å§“å" /></label>
        <label><span>éŠ·å”®å“å</span><input type="text" id="productName" placeholder="è«‹è¼¸å…¥éŠ·å”®å“å" /></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input type="number" id="actualWeight" placeholder="0" /></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input type="number" id="actualPrice" placeholder="0" /></label>
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
        <label><input type="checkbox" id="homeDelivery" /> å®…é…ï¼ˆæ‰£250å…ƒï¼‰</label>
        <label><input type="checkbox" id="selfDelivery" /> è‡ªè¡Œé…é€ï¼ˆæ¯å…¬æ–¤åŠ 3å…ƒï¼‰</label>
        <label><input type="checkbox" id="companyDriver" /> å…¬å¸å¸æ©Ÿï¼ˆæ¯å…¬æ–¤æ‰£3å…ƒï¼‰</label>
        <label><input type="checkbox" id="kaohsiungLocal" /> é«˜é›„å¸‚å€å…¬å¸è»Šï¼ˆåŠ 5å…ƒï¼‰</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—çé‡‘</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <button class="btn" id="btnHome">è¿”å›ä¸»é </button>
        <button class="btn danger" id="btnClearOne">æ¸…é™¤ä¸Šä¸€ç­†</button>
      </div>

      <p class="highlight">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>
      <p>æœ¬æœˆç´¯ç©çé‡‘ï¼š<span id="totalBonus">0</span> å…ƒ</span></p>
      <div class="table">
        <strong>ç´€éŒ„</strong>
        <pre id="historyDisplay"></pre>
      </div>
      <p class="notice">æç¤ºï¼šæ¯åˆ°æ–°æœˆä»½æœƒè‡ªå‹•å°‡ä¸Šæœˆç´€éŒ„ç§»å…¥æ­·å²å€ã€‚</p>
    </section>
  </div>

  <nav class="dock">
    <button class="btn primary" id="dockCalc">è¨ˆç®—</button>
    <button class="btn ok" id="dockExport">åŒ¯å‡º CSV</button>
    <button class="btn" id="dockHome">ä¸»é </button>
    <button class="btn danger" id="dockClearOne">æ¸…é™¤ä¸Šä¸€ç­†</button>
  </nav>

  <script>
    const base = Math.round(parseFloat(localStorage.getItem("basePrice") || "0"));
    let bonusData = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
    document.getElementById("basePriceDisplay").innerText = isFinite(base) ? base.toFixed(0) : "-";
    updateTotal(); showHistory();

    (function handleMonthChange(){
      const d = new Date();
      const key = d.getFullYear() + "-" + (d.getMonth()+1);
      const last = localStorage.getItem("bonusMonth");
      if (last && last !== key) {
        const history = JSON.parse(localStorage.getItem("bonusHistory") || "[]");
        history.push({ month: last, data: bonusData });
        localStorage.setItem("bonusHistory", JSON.stringify(history));
        bonusData = [];
        localStorage.setItem("monthlyBonus", JSON.stringify(bonusData));
      }
      localStorage.setItem("bonusMonth", key);
    })();

    function showHistory() {
      const current = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      const history = JSON.parse(localStorage.getItem("bonusHistory") || "[]");
      let output = "ğŸ“˜ æœ¬æœˆç´€éŒ„ï¼š\n";
      if (current.length === 0) output += "ï¼ˆå°šç„¡ï¼‰\n";
      else current.forEach(r => {
        output += `  ğŸ•’ ${r.date} - ${r.name} éŠ·å”® ${r.product} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ\n`;
      });
      if (history.length > 0) {
        output += "\nğŸ“š æ­·å²ç´€éŒ„ï¼š\n";
        history.forEach(entry => {
          output += `ğŸ“… ${entry.month}\n`;
          entry.data.forEach(r => {
            output += `  ğŸ•’ ${r.date} - ${r.name} éŠ·å”® ${r.product} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ\n`;
          });
          output += "\n";
        });
      }
      document.getElementById("historyDisplay").innerText = output;
    }

    function calculateBonus() {
      const actual = parseFloat(document.getElementById("actualPrice").value || 0);
      const weight = parseFloat(document.getElementById("actualWeight").value || 0);
      const sales = document.getElementById("salesName").value.trim();
      const product = document.getElementById("productName").value.trim();
      if (!sales || !product) return alert("è«‹è¼¸å…¥æ¥­å‹™å§“åèˆ‡éŠ·å”®å“å");
      const deduct = document.getElementById("homeDelivery").checked ? 250 : 0;
      const addSelf = document.getElementById("selfDelivery").checked ? weight * 3 : 0;
      const deductDriver = document.getElementById("companyDriver").checked ? weight * 3 : 0;
      const addKaohsiung = document.getElementById("kaohsiungLocal").checked ? 5 : 0;
      const diff = actual - base;
      const bonus = diff > 0 ? diff * weight - deduct - deductDriver + addSelf + addKaohsiung : 0;
      document.getElementById("bonusResult").innerText = isFinite(bonus) ? bonus.toFixed(0) : "0";
      const total = actual * weight;
      bonusData.push({ date: new Date().toLocaleString(), name: sales, product, weight, price: actual, total, bonus: Number(bonus.toFixed(0)) });
      localStorage.setItem("monthlyBonus", JSON.stringify(bonusData));
      updateTotal(); showHistory();
    }

    function updateTotal() {
      const total = bonusData.reduce((sum, r) => sum + (Number(r.bonus)||0), 0);
      document.getElementById("totalBonus").innerText = isFinite(total) ? total.toFixed(0) : "0";
    }

    function exportCSV() {
      let csv = "æ¥­å‹™å§“å,éŠ·å”®å“å,æ•¸é‡(kg),æˆäº¤å–®åƒ¹,ç¸½é‡‘é¡,çé‡‘,æ—¥æœŸ\n";
      bonusData.forEach(r => {
        csv += `${r.name},${r.product},${r.weight},${r.price},${r.total},${r.bonus},${r.date}\n`;
      });
      const blob = new Blob([\"\uFEFF\" + csv], { type: \"text/csv;charset=utf-8;\" });
      const link = document.createElement(\"a\"); link.href = URL.createObjectURL(blob); link.download = \"æ¥­å‹™çé‡‘å ±è¡¨.csv\"; link.click();
    }

    function clearBonus() {
      if (!bonusData.length) return alert(\"ç›®å‰æ²’æœ‰å¯åˆªé™¤çš„ç´€éŒ„\");
      if (confirm(\"ç¢ºå®šè¦åˆªé™¤ä¸Šä¸€ç­†çé‡‘ç´€éŒ„ï¼Ÿ\")) {
        bonusData.pop();
        localStorage.setItem(\"monthlyBonus\", JSON.stringify(bonusData));
        updateTotal(); showHistory();
        alert(\"å·²åˆªé™¤ä¸Šä¸€ç­†ç´€éŒ„\");
      }
    }

    [\"btnCalc\",\"dockCalc\"].forEach(id=> document.getElementById(id).onclick = calculateBonus);
    [\"btnExport\",\"dockExport\"].forEach(id=> document.getElementById(id).onclick = exportCSV);
    [\"btnHome\",\"dockHome\"].forEach(id=> document.getElementById(id).onclick = ()=> location.href = \"index_rwd.html\");
    [\"btnClearOne\",\"dockClearOne\"].forEach(id=> document.getElementById(id).onclick = clearBonus);
  </script>
</body>
</html>
