<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</title>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--bd:#ddd;--muted:#666;--brand:#4f8cff;--brand2:#7aa2ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;color:#222}
    .container{max-width:1000px;margin:0 auto;padding:16px 16px 100px}
    h1{margin:0 0 8px}.lead{color:var(--muted);margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    input,button,a.btn{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    label span{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .btn{cursor:pointer;background:#f3f4f6;text-align:center;text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#fff;border:none;font-weight:600}
    .btn.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    .btn.danger{background:#fde2e2;border-color:#f5c2c7;color:#842029}
    .actions{display:grid;gap:10px;grid-template-columns:1fr 1fr} @media(min-width:640px){.actions{grid-template-columns:repeat(4,1fr)}}
    .dock{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-top:1px solid var(--bd);padding:10px;display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(min-width:640px){.dock{grid-template-columns:repeat(4,1fr)}}
    .table{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px;margin-top:12px}
    pre{white-space:pre-wrap}
    .toast-wrap{position:fixed;right:12px;bottom:12px;z-index:9999;display:grid;gap:8px;max-width:80vw}
    .toast{background:rgba(0,0,0,.82);color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);font-size:14px}
    .dbg{position:fixed;left:12px;bottom:12px;background:rgba(255,255,255,.9);border:1px solid var(--bd);padding:8px;border-radius:10px;font-size:12px;box-shadow:0 6px 20px rgba(0,0,0,.1);z-index:9998}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’¼ æ¥­å‹™çé‡‘è¨ˆç®—</h1>
    <p class="lead">åº•åƒ¹è‡ªå‹•å¸¶å…¥ï¼ˆå¯æ‰‹å‹•è¦†å¯«ï¼‰ï½œæœ¬æœˆå³æ™‚åŒæ­¥ã€å¯é€ç­†åˆªé™¤ï½œæ­·å²æœˆä»½çµ±è¨ˆ</p>
    <section class="card">
      <p>æ¯å…¬æ–¤åº•åƒ¹ï¼ˆå››æ¨äº”å…¥ï¼‰ï¼š<span id="basePriceDisplay" class="em">-</span> å…ƒ</p>
      <div class="grid">
        <label><span>æ¥­å‹™å§“å</span><input id="salesName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>éŠ·å”®å“å</span><input id="productName" type="text" placeholder="å¯ç•™ç©º"/></label>
        <label><span>æˆäº¤é‡é‡ (kg)</span><input id="actualWeight" type="number" placeholder="0"/></label>
        <label><span>æˆäº¤å–®åƒ¹ (å…ƒ/kg)</span><input id="actualPrice" type="number" placeholder="0"/></label>
        <label><span>æˆæœ¬ (å…ƒ/kg)</span><input id="costPerKg" type="number" placeholder="è‡ªå‹•å¸¶å…¥ï¼Œå¯æ‰‹å‹•ä¿®æ”¹"/></label>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <label><input type="checkbox" id="homeDelivery"/> å®…é…ï¼ˆæ‰£250å…ƒï¼‰</label>
        <label><input type="checkbox" id="selfDelivery"/> è‡ªè¡Œé…é€ï¼ˆæ¯å…¬æ–¤åŠ 3å…ƒï¼‰</label>
        <label><input type="checkbox" id="companyDriver"/> å…¬å¸å¸æ©Ÿï¼ˆæ¯å…¬æ–¤æ‰£3å…ƒï¼‰</label>
        <label><input type="checkbox" id="kaohsiungLocal"/> é«˜é›„å¸‚å€å…¬å¸è»Šï¼ˆæ•´ç­† +5 å…ƒï¼‰</label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—çé‡‘</button>
        <button class="btn ok" id="btnExport">åŒ¯å‡º CSV</button>
        <a class="btn primary" href="./index.html">è¿”å›ä¸»é </a>
        <button class="btn danger" id="btnClearOne">æ¸…é™¤ä¸Šä¸€ç­†</button>
      </div>

      <p class="em">æœ¬æ¬¡çé‡‘ï¼š<span id="bonusResult">0</span> å…ƒ</p>
      <p>æœ¬æœˆç´¯ç©çé‡‘ï¼š<span id="totalBonus">0</span> å…ƒ</p>

      <div class="table">
        <strong>ç´€éŒ„</strong>
        <pre id="historyDisplay"></pre>
        <div id="monthlyButtons" style="margin-top:8px;"></div>
        <div id="historyControls" style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <button class="btn" id="btnToggleHistory">é¡¯ç¤ºæ­·å²æœˆä»½</button>
          <div>
            <select id="monthSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;"></select>
            <button class="btn" id="btnLoadMonth" style="margin-top:6px;">è¼‰å…¥é¸å–æœˆä»½</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <nav class="dock">
    <button class="btn primary" id="dockCalc">è¨ˆç®—</button>
    <button class="btn ok" id="dockExport">åŒ¯å‡º CSV</button>
    <a class="btn primary" href="./index.html">ä¸»é </a>
    <button class="btn danger" id="dockClearOne">æ¸…é™¤ä¸Šä¸€ç­†</button>
  </nav>

  <div id="toast-wrap" class="toast-wrap" hidden></div>
  <div class="dbg" id="dbgPanel">UID: â€”<br>Profile: default<br>æœ¬åœ°ç­†æ•¸: 0</div>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    const db = firebase.firestore();
    try { db.enablePersistence({synchronizeTabs:true}); } catch(e){ console.warn(e); }
    firebase.auth().signInAnonymously().catch(console.warn);
    const PROFILE_ID = "default"; // å›ºå®šç‚º default

    function toast(msg, ms=2200){
      const wrap = document.getElementById('toast-wrap'); wrap.hidden=false;
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .25s'; setTimeout(()=>t.remove(), 300); }, ms);
    }
    const $ = id=>document.getElementById(id);
    const num = v=>{const n=parseFloat(v);return isFinite(n)?n:null;};
    const ymKey = (d=new Date()) => d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");

    function pickBase(){
      const fromInput = num($("costPerKg") && $("costPerKg").value);
      if (fromInput !== null) return fromInput;
      const urlBp = num(new URLSearchParams(location.search).get("bp"));
      if (urlBp !== null) return urlBp;
      const stored = num(localStorage.getItem("basePrice"));
      if (stored !== null) return stored;
      return null;
    }
    async function maybeFetchBaseFromCloud(){
      const el = $("costPerKg");
      const has = el && el.value.trim() !== "";
      const urlBp = new URLSearchParams(location.search).get("bp");
      const localBp = localStorage.getItem("basePrice");
      if (has || (urlBp && !isNaN(parseFloat(urlBp))) || (localBp && !isNaN(parseFloat(localBp)))) return;
      try{
        const snap = await db.collection("profiles").doc(PROFILE_ID).collection("settings").doc("base").get();
        if (snap.exists && isFinite(snap.data().basePrice)){
          const v = Math.round(Number(snap.data().basePrice));
          if (el && !el.value) el.value = String(v);
          const disp = $("basePriceDisplay"); if (disp) disp.innerText = String(v);
          localStorage.setItem("basePrice", String(snap.data().basePrice));
        }
      }catch(e){ console.warn(e); }
    }
    function refreshBaseDisplay(){
      const disp = $("basePriceDisplay");
      const v = pickBase();
      disp.innerText = v !== null ? String(Math.round(v)) : "-";
    }

    function renderCurrent(arr){
      let out = "ğŸ“˜ æœ¬æœˆç´€éŒ„ï¼š\n";
      if(!arr.length) out += "ï¼ˆå°šç„¡ï¼‰\n";
      else arr.forEach((r,i)=> out += `  #${i+1}  ğŸ•’ ${r.date||""} - ${(r.name||"")} éŠ·å”® ${(r.product||"")} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ\n`);
      $("historyDisplay").innerText = out;
      const box = $("monthlyButtons"); box.innerHTML="";
      arr.forEach((_,i)=>{
        const b = document.createElement("button"); b.className="btn danger"; b.style.marginRight="8px";
        b.textContent = "åˆªé™¤ç¬¬ " + (i+1) + " ç­†"; b.onclick = ()=> deleteByIndex(i); box.appendChild(b);
      });
      const total = arr.reduce((s,r)=> s + (Number(r.bonus)||0), 0);
      $("totalBonus").innerText = String(Math.round(total));
    }

    async function pushLocalIfCloudEmpty(){
      const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      if (!arr.length) return false;
      const ym = ymKey();
      try{
        const q = await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records").limit(1).get();
        if (!q.empty) return false;
        let t0=Date.now();
        for(let i=0;i<arr.length;i++){
          const r = arr[i];
          await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records")
            .add(Object.assign({}, r, { createdAt: (typeof r.createdAt==='number'? r.createdAt : (t0+i)) }));
        }
        await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).set({month:ym,updatedAt:Date.now()},{merge:true});
        toast("é›²ç«¯ç„¡è³‡æ–™ï¼Œå·²å¾æœ¬åœ°ä¸Šå‚³ "+arr.length+" ç­†");
        return true;
      }catch(e){ console.warn(e); return false; }
    }

    function exportCSV(){
      const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      let csv = "æ¥­å‹™å§“å,éŠ·å”®å“å,æ•¸é‡(kg),æˆäº¤å–®åƒ¹,ç¸½é‡‘é¡,çé‡‘,æ—¥æœŸ\n";
      arr.forEach(r=> csv += `${r.name||""},${r.product||""},${r.weight},${r.price},${r.total},${r.bonus},${r.date}\n`);
      const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="æ¥­å‹™çé‡‘å ±è¡¨.csv"; a.click();
    }

    async function deleteByIndex(i){
      const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      if (i<0 || i>=arr.length) return alert("ç´¢å¼•è¶…å‡ºç¯„åœ");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†ï¼ˆåƒ…æœ¬æœˆï¼‰ï¼Ÿ")) return;
      const target = arr[i];
      const ym = ymKey();
      try{
        const col = db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records");
        if (target && target._id) await col.doc(target._id).delete();
        else if (typeof target?.createdAt === "number"){
          const q = await col.where("createdAt","==", target.createdAt).limit(1).get();
          if (!q.empty) await q.docs[0].ref.delete();
        }
      }catch(e){ console.warn(e); }
      arr.splice(i,1); localStorage.setItem("monthlyBonus", JSON.stringify(arr)); renderCurrent(arr);
    }

    // === æ‰‹æ©Ÿç©©å®šï¼šå…ˆæ‹‰ä¸€æ¬¡ï¼Œå†ç›£è½ ===
    async function initialPull(){
      const ym = ymKey();
      const snap = await db.collection("profiles").doc(PROFILE_ID)
        .collection("months").doc(ym).collection("records")
        .orderBy("createdAt","asc").get();
      const arr=[]; snap.forEach(doc=> arr.push(Object.assign({_id:doc.id}, doc.data())));
      localStorage.setItem("monthlyBonus", JSON.stringify(arr));
      renderCurrent(arr);
    }

    // ==== æ‰‹æ©Ÿå¯ç”¨çš„æ­·å²æœˆä»½åˆ—å‡ºï¼ˆcollectionGroup ç‰ˆï¼‰ ====
    async function populateMonths(){
      const sel = $("monthSelect");
      if (!sel) return;
      sel.innerHTML = "";
      try{
        const snap = await db.collectionGroup("records")
          .orderBy("createdAt","desc")
          .limit(200).get();
        const seen = new Set(); const months = [];
        snap.forEach(doc => {
          const ymDoc = doc.ref.parent.parent;
          if (!ymDoc) return;
          const ym = ymDoc.id;
          if (!seen.has(ym)) { seen.add(ym); months.push(ym); }
        });
        if (months.length === 0){
          const opt = document.createElement("option");
          opt.value=""; opt.textContent="ï¼ˆæ²’æœ‰æ­·å²æœˆä»½ï¼‰"; sel.appendChild(opt); return;
        }
        months.forEach(ym => {
          const opt = document.createElement("option");
          opt.value = ym; opt.textContent = ym; sel.appendChild(opt);
        });
      }catch(e){
        console.warn("populateMonths (collectionGroup) failed:", e);
        try{
          const snap2 = await db.collection("profiles").doc(PROFILE_ID).collection("months").orderBy("updatedAt","desc").limit(36).get();
          if (snap2.empty){
            const opt = document.createElement("option"); opt.value=""; opt.textContent="ï¼ˆæ²’æœ‰æ­·å²æœˆä»½ï¼‰"; sel.appendChild(opt); return;
          }
          snap2.forEach(doc=>{
            const d=doc.data(); const opt=document.createElement("option");
            opt.value=d.month || doc.id; opt.textContent=d.month || doc.id; sel.appendChild(opt);
          });
        }catch(e2){ console.warn("fallback months failed:", e2); }
      }
    }

    async function loadMonthAndShow(ym){
      if (!ym) return;
      try{
        const snap = await db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records")
          .orderBy("createdAt","asc").get();
        const arr=[]; let sumT=0,sumB=0;
        snap.forEach(doc=>{ const d=doc.data(); arr.push(d); sumT+=Number(d.total)||0; sumB+=Number(d.bonus)||0; });
        let out=`ğŸ“š æ­·å²ç´€éŒ„ï¼š${ym}\n`;
        if(!arr.length) out+="ï¼ˆè©²æœˆæ²’æœ‰ç´€éŒ„ï¼‰\n";
        else{ arr.forEach((r,i)=> out+=`  #${i+1}  ğŸ•’ ${r.date||""} - ${(r.name||"")} éŠ·å”® ${(r.product||"")} ${r.weight}kgï¼Œå–®åƒ¹ ${r.price}ï¼Œçé‡‘ ${r.bonus} å…ƒ\n`);
              out+=`\nâ€” çµ±è¨ˆï¼šç¸½é‡‘é¡ ${Math.round(sumT)} å…ƒï½œç¸½çé‡‘ ${Math.round(sumB)} å…ƒ\n`; }
        $("historyDisplay").innerText = out; $("monthlyButtons").innerHTML="";
      }catch(e){
        console.warn("loadMonthAndShow:", e); alert("è®€å–æ­·å²æœˆä»½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    }

    function calculateBonus(){
      const actual = num($("actualPrice").value);
      const weight = num($("actualWeight").value);
      if (actual === null || weight === null || weight<=0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤å–®åƒ¹èˆ‡é‡é‡");
      const cost = pickBase(); if (cost === null) return alert("è«‹å…ˆè¼¸å…¥ã€æˆæœ¬(å…ƒ/kg)ã€æˆ–å›ä¸»é è¨ˆç®—åº•åƒ¹");

      const deduct = $("homeDelivery").checked ? 250 : 0;
      const addSelf = $("selfDelivery").checked ? weight * 3 : 0;
      const deductDriver = $("companyDriver").checked ? weight * 3 : 0;
      const addKHH = $("kaohsiungLocal").checked ? 5 : 0;
      const diff = actual - cost;
      const bonus = diff > 0 ? diff * weight - deduct - deductDriver + addSelf + addKHH : 0;
      $("bonusResult").innerText = String(Math.round(bonus));

      const rec = {
        date: new Date().toLocaleString(),
        name: $("salesName").value.trim(),
        product: $("productName").value.trim(),
        weight, price: actual, total: actual*weight, bonus: Math.round(bonus),
        createdAt: Date.now()
      };
      const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      arr.push(rec); localStorage.setItem("monthlyBonus", JSON.stringify(arr)); renderCurrent(arr);

      const ym = ymKey();
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records")
        .add(rec).catch(console.warn);
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym)
        .set({month:ym,updatedAt:Date.now()},{merge:true});
    }

    function clearLast(){
      const arr = JSON.parse(localStorage.getItem("monthlyBonus") || "[]");
      if (!arr.length) return alert("æœ¬æœˆç›®å‰æ²’æœ‰å¯åˆªé™¤çš„ç´€éŒ„");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æœ¬æœˆä»½ä¸Šä¸€ç­†ï¼Ÿ")) return;
      arr.pop(); localStorage.setItem("monthlyBonus", JSON.stringify(arr)); renderCurrent(arr);
      const ym = ymKey();
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records")
        .orderBy("createdAt","desc").limit(1).get().then(q=>{ if(!q.empty) q.docs[0].ref.delete(); }).catch(console.warn);
    }

    firebase.auth().onAuthStateChanged(async u=>{
      $("dbgPanel").innerHTML = `UID: ${u?u.uid:"ï¼ˆæœªç™»å…¥ï¼‰"}<br>Profile: default<br>æœ¬åœ°ç­†æ•¸: ${(JSON.parse(localStorage.getItem('monthlyBonus')||'[]').length)}`;
      if(!u || window._startedRealtimeOnce) return;
      window._startedRealtimeOnce = true;

      (function(){ const el=$("costPerKg"); if(el && !el.value){ const v=pickBase(); if(v!==null) el.value=String(Math.round(v)); } refreshBaseDisplay(); })();
      maybeFetchBaseFromCloud();

      await pushLocalIfCloudEmpty();
      await initialPull(); // å…ˆæ‹‰ä¸€æ¬¡ï¼Œæ‰‹æ©Ÿç«‹å³æœ‰è³‡æ–™

      const ym = ymKey();
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).collection("records")
        .orderBy("createdAt","asc").onSnapshot(snap=>{
          const arr=[]; snap.forEach(doc=> arr.push(Object.assign({_id:doc.id}, doc.data())));
          localStorage.setItem("monthlyBonus", JSON.stringify(arr));
          renderCurrent(arr);
          toast("å·²é€£ç·šé›²ç«¯ï¼Œå³æ™‚åŒæ­¥å•Ÿå‹•");
        });
      db.collection("profiles").doc(PROFILE_ID).collection("months").doc(ym).set({month:ym,updatedAt:Date.now()},{merge:true});
    });

    document.addEventListener("DOMContentLoaded", ()=>{
      ["btnCalc","dockCalc"].forEach(id=> $(id).onclick = calculateBonus);
      ["btnExport","dockExport"].forEach(id=> $(id).onclick = exportCSV);
      ["btnClearOne","dockClearOne"].forEach(id=> $(id).onclick = clearLast);
      $("costPerKg")?.addEventListener("input", refreshBaseDisplay);
      $("btnToggleHistory").addEventListener("click", async (e)=>{
        const t=e.currentTarget;
        if(t.dataset.view==="history"){ t.dataset.view="current"; t.textContent="é¡¯ç¤ºæ­·å²æœˆä»½"; renderCurrent(JSON.parse(localStorage.getItem("monthlyBonus")||"[]")); }
        else{ t.dataset.view="history"; t.textContent="å›åˆ°æœ¬æœˆ"; await populateMonths(); }
      });
      $("btnLoadMonth").addEventListener("click", ()=>{ const ym=$("monthSelect").value; if(ym) loadMonthAndShow(ym); });

      renderCurrent(JSON.parse(localStorage.getItem("monthlyBonus") || "[]"));
      refreshBaseDisplay();
    });
  </script>
</body>
</html>
