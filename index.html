<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è¦ä»æˆæœ¬å ±åƒ¹è©¦ç®—è¡¨ï¼ˆRWD æ·ºè‰²ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --muted:#555;
      --text:#222;
      --brand:#4f8cff;
      --brand-2:#7aa2ff;
      --danger:#d9534f;
      --ok:#32d296;
      --bd:#ccc;
      --radius:12px;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container{ max-width:1000px; margin:0 auto; padding: max(env(safe-area-inset-top), 16px) 16px calc(88px + env(safe-area-inset-bottom)); }
    h1{ font-size: clamp(20px, 3.5vw, 28px); margin:0 0 12px; }
    p.lead{ color:var(--muted); margin:0 0 18px; }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:var(--radius); padding:16px; }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:640px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width:960px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    label span{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, button, a.btn{
      width:100%; padding:10px; border-radius:8px; border:1px solid var(--bd); background:#fff; color:var(--text);
    }
    .btn{ cursor:pointer; border:1px solid var(--bd); background:#f0f0f0; text-decoration:none; display:block; text-align:center; }
    .btn.primary{ background:linear-gradient(180deg, var(--brand-2), var(--brand)); border:none; color:#fff; font-weight:600; }
    .btn.ok{ background:#d4edda; border-color:#c3e6cb; color:#155724; }
    .btn.danger{ background:#f8d7da; border-color:#f5c6cb; color:#a94442; }
    .actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    @media (min-width:640px){ .actions{ grid-template-columns: repeat(4, 1fr); } }
    .result{ margin-top:10px; background:#fff; border:1px solid var(--bd); border-radius:8px; padding:12px; }
    .result p{ margin:6px 0; }
    .result .em{ color:#b00020; font-weight:700; }
    .dock{
      position:fixed; left:0; right:0; bottom:0; backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.9); border-top:1px solid var(--bd);
      padding:10px 12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    @media (min-width:640px){ .dock{ grid-template-columns: repeat(4, 1fr); } }
  </style>

  <style>
    .toast-wrap{position:fixed;right:12px;bottom:12px;z-index:9999;display:grid;gap:8px;max-width:80vw}
    .toast{background:rgba(0,0,0,.8);color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);font-size:14px}
    @media (prefers-color-scheme: light){
      .toast{background:rgba(50,50,50,.9)}
    }
  </style>

</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¦ è¦ä»æˆæœ¬å ±åƒ¹è©¦ç®—è¡¨</h1>
      <p class="lead">æ‰‹æ©Ÿå‹å–„ï½œè‡ªå‹•è¨ˆç®—æˆæœ¬ã€åº•åƒ¹ï¼ˆå­˜ localStorage çµ¦çé‡‘é ç”¨ï¼‰</p>
    </header>

    <section class="card">
      <div class="grid">
        <label><span>åŸæ–™é‡é‡ (kg)</span><input type="number" id="rawWeight" value="16" /></label>
        <label><span>åŸæ–™å–®åƒ¹ (å…ƒ/kg)</span><input type="number" id="rawPrice" value="420" /></label>
        <label><span>ç™¼æ³¡ç‡ (%)</span><input type="number" id="foamRate" value="25" /></label>
        <label><span>åŒ…å†°ç‡ (%)</span><input type="number" id="iceRate" value="20" /></label>
        <label><input type="checkbox" id="cut" /> æ˜¯å¦å‰²èƒŒï¼ˆæ¯å…¬æ–¤ +13 å…ƒï¼‰</label>
        <label style="grid-column:1 / -1;">
          <input type="radio" name="foamType" id="outsourceFoam" checked /> å§”å¤–ç™¼æ³¡ï¼ˆæ¯å…¬æ–¤ +15 å…ƒï¼‰
          &nbsp; &nbsp;
          <input type="radio" name="foamType" id="selfFoam" /> è‡ªè¡Œç™¼æ³¡ï¼ˆæ¯å…¬æ–¤ +12 å…ƒï¼‰
        </label>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—</button>
        <a class="btn" id="btnToBonus" href="./bonus.html">å‰å¾€çé‡‘é </a>
        <button class="btn ok" id="btnCopyBase">è¤‡è£½åº•åƒ¹</button>
        <button class="btn danger" id="btnReset">æ¸…ç©º</button>
      </div>

      <div id="results" class="result" aria-live="polite"></div>
    </section>
  </div>

  <nav class="dock">
    <button class="btn primary" id="dockCalc">è¨ˆç®—</button>
    <a class="btn" id="dockToBonus" href="./bonus.html">çé‡‘é </a>
    <button class="btn ok" id="dockCopyBase">è¤‡è£½åº•åƒ¹</button>
    <button class="btn danger" id="dockReset">æ¸…ç©º</button>
  </nav>

  <script>
    function calculate() {
      const rawWeight = parseFloat(document.getElementById("rawWeight").value || 0);
      const rawPrice = parseFloat(document.getElementById("rawPrice").value || 0);
      const foamRate = parseFloat(document.getElementById("foamRate").value || 0) / 100;
      const iceRate = parseFloat(document.getElementById("iceRate").value || 0) / 100;
      const cut = document.getElementById("cut").checked;
      const isOutsource = document.getElementById("outsourceFoam").checked;

      const cutCost = cut ? rawWeight * 13 : 0;
      const foamWeight = rawWeight * (1 + foamRate);
      const foamCost = isOutsource ? foamWeight * 15 : foamWeight * 12;
      const iceWeight = foamWeight / (1 - iceRate);
      const iceCost = iceWeight * 18;
      const rawCost = rawWeight * rawPrice;

      const totalCost = rawCost + cutCost + foamCost + iceCost;
      const costPerKg = iceWeight > 0 ? (totalCost / iceWeight) : 0;
      const basePrice = costPerKg / 0.85;
      const suggestedPrice = costPerKg / 0.75;

      localStorage.setItem("basePrice", basePrice.toFixed(2));
      function updateBonusLinks(){
        const bp = localStorage.getItem("basePrice");
        const rounded = bp && isFinite(parseFloat(bp)) ? Math.round(parseFloat(bp)) : null;
        ["btnToBonus","dockToBonus"].forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          el.href = rounded ? "./bonus.html?bp="+rounded : "./bonus.html";
        });
      }
      updateBonusLinks();


      updateBonusLinks();
      document.getElementById("results").innerHTML = `
        <p>ç¸½æˆæœ¬ï¼š<span class="em">${totalCost.toFixed(0)}</span> å…ƒ</p>
        <p>æˆå“é‡é‡ï¼š<span class="em">${iceWeight.toFixed(2)}</span> å…¬æ–¤</p>
        <p>æ¯å…¬æ–¤æˆæœ¬ï¼š<span class="em">${costPerKg.toFixed(0)}</span> å…ƒ</p>
        <p>åº•åƒ¹ï¼ˆæ¯›åˆ©15%ï¼‰ï¼š<span class="em" id="basePriceText">${basePrice.toFixed(0)}</span> å…ƒ</p>
        <p>å»ºè­°å”®åƒ¹ï¼ˆæ¯›åˆ©25%ï¼‰ï¼š<span class="em">${suggestedPrice.toFixed(0)}</span> å…ƒ</p>
      `;
    }

    function copyBase(){
      const bp = document.getElementById("basePriceText")?.innerText || localStorage.getItem("basePrice") || "";
      if(!bp){ alert("è«‹å…ˆè¨ˆç®—ä¸€æ¬¡åº•åƒ¹"); return; }
      navigator.clipboard.writeText(bp).then(()=> alert("å·²è¤‡è£½åº•åƒ¹ï¼š"+bp));
    }

    function resetForm(){
      ["rawWeight","rawPrice","foamRate","iceRate"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("cut").checked = false;
      document.getElementById("outsourceFoam").checked = true;
      document.getElementById("selfFoam").checked = false;
      document.getElementById("results").innerHTML = "";
      localStorage.removeItem("basePrice");
    }

    function goBonus(){
      const url = new URL("bonus.html", location.href);
      location.assign(url.href);
    }

      // åœ¨é é¢è¼‰å…¥æ™‚ä¹Ÿæ›´æ–°ä¸€æ¬¡ã€Œå‰å¾€çé‡‘é ã€é€£çµï¼Œè‹¥ localStorage å·²æœ‰ basePrice å°±å¸¶ ?bp
      (function initBonusLinksOnLoad(){
        const bp = localStorage.getItem("basePrice");
        const rounded = bp && isFinite(parseFloat(bp)) ? Math.round(parseFloat(bp)) : null;
        ["btnToBonus","dockToBonus"].forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          el.href = rounded ? "./bonus.html?bp="+rounded : "./bonus.html";
        });
      })();


    ["btnCalc","dockCalc"].forEach(id=> document.getElementById(id).onclick = calculate);
    ["btnToBonus","dockToBonus"].forEach(id=> document.getElementById(id)?.addEventListener("click", (e)=>{ /* href handles nav; JS fallback only */ }));
    ["btnCopyBase","dockCopyBase"].forEach(id=> document.getElementById(id).onclick = copyBase);
    ["btnReset","dockReset"].forEach(id=> document.getElementById(id).onclick = resetForm);
  </script>

  <!-- Firebase compat CDN (no UI changes) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    // ğŸ”§ å°‡ä½ çš„ Firebase å°ˆæ¡ˆè¨­å®šå¡«åœ¨é€™è£¡ï¼Œæˆ–åœ¨å¤–éƒ¨æ–¼ window.FIREBASE_CONFIG æŒ‡å®š
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    // åŒ¿åç™»å…¥ï¼ˆæ–¹ä¾¿å¤šè£ç½®åŒæ­¥ï¼›éœ€ Firestore è¦å‰‡å…è¨±ï¼‰
    try { firebase.auth().signInAnonymously(); } catch(e){ console.warn(e); }
    const db = firebase.firestore();
    // ä½¿ç”¨è€…/è£ç½®è­˜åˆ¥ï¼ˆå¯è‡ªè¡Œè¨­å®šå›ºå®š IDï¼‰
    const PROFILE_ID = localStorage.getItem("profileId") || "default";
  </script>

  <script>
    // === BasePrice Firestore åŒæ­¥ï¼ˆindex.htmlï¼‰ ===
    async function syncBaseToFirestore(basePrice){
      try{
        await db.collection("profiles").doc(PROFILE_ID)
          .collection("settings").doc("base")
          .set({ basePrice: Number(basePrice), updatedAt: Date.now() }, { merge:true });
      }catch(err){ console.warn("syncBaseToFirestore:", err); }
    }
    async function loadBaseFromFirestore(){
      try{
        const snap = await db.collection("profiles").doc(PROFILE_ID)
          .collection("settings").doc("base").get();
        const data = snap.exists ? snap.data() : null;
        if (data && isFinite(data.basePrice)){
          // å¯«å› localStorage èˆ‡ç•«é¢ï¼ˆä¸ç ´å£ RWDï¼‰
          localStorage.setItem("basePrice", String(data.basePrice));
          const el = document.getElementById("results");
          // ä¸å¼·æ”¹ UIï¼Œåªæ›´æ–°å‰å¾€çé‡‘é çš„é€£çµï¼ˆ?bp=ï¼‰
          const rounded = Math.round(data.basePrice);
          [ "btnToBonus","dockToBonus" ].forEach(id=>{
            const a = document.getElementById(id);
            if (a) a.href = "./bonus.html?bp=" + rounded;
          });
        }
      }catch(err){ console.warn("loadBaseFromFirestore:", err); }
    }
    // è¼‰å…¥æ™‚å…ˆæŠ“ä¸€æ¬¡é›²ç«¯ basePrice
    document.addEventListener("DOMContentLoaded", loadBaseFromFirestore);

    // æ””æˆªåŸæœ¬çš„ calculateï¼Œè¨ˆç®—å¾ŒæŠŠ basePrice ä¹ŸåŒæ­¥åˆ°é›²ç«¯
    (function wrapCalculate(){
      const btns = ["btnCalc","dockCalc"].map(id=> document.getElementById(id));
      const origClick = (el)=> el && el.onclick;
      btns.forEach(el=>{
        if(!el) return;
        const old = el.onclick;
        el.onclick = function(){
          // å…ˆåŸ·è¡ŒåŸæœ¬è¨ˆç®—ï¼ˆæœƒå¯« localStorage.basePriceï¼‰
          if (typeof old === "function") old.call(this);
          // è®€ localStorage å¾ŒåŒæ­¥
          const bp = parseFloat(localStorage.getItem("basePrice"));
          if (isFinite(bp)) syncBaseToFirestore(bp);
        };
      });
    })();
  </script>


  <script>
    (function initToast(){
      if (document.getElementById('toast-wrap')) return;
      const w = document.createElement('div');
      w.id = 'toast-wrap'; w.className = 'toast-wrap';
      document.body.appendChild(w);
      window.showToast = function(msg, ms=2200){
        try{
          const item = document.createElement('div');
          item.className = 'toast';
          item.textContent = msg;
          w.appendChild(item);
          setTimeout(()=>{
            item.style.opacity = '0';
            item.style.transition = 'opacity .25s ease';
            setTimeout(()=> item.remove(), 300);
          }, ms);
        }catch(e){ console.warn(e); }
      };
    })();
  </script>


  <script>
    (function hookIndexToasts(){
      // Base loaded toast already inside loadBaseFromFirestoreToLinks if we add it:
      const oldLoad = window.loadBaseFromFirestoreToLinks;
      window.loadBaseFromFirestoreToLinks = async function(){
        const before = localStorage.getItem("basePrice");
        try{
          await oldLoad();
        }catch(e){ console.warn(e); }
        const after = localStorage.getItem("basePrice");
        if ((!before || before !== after) && after){
          try{ showToast("å·²å¾é›²ç«¯è¼‰å…¥åº•åƒ¹ï¼š" + Math.round(parseFloat(after)) + " å…ƒ"); }catch(e){}
        }
      };

      // Hook calculate buttons to show sync toast
      ["btnCalc","dockCalc"].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        const old = el.onclick;
        el.onclick = function(){
          if (typeof old === "function") old.call(this);
          const bp = parseFloat(localStorage.getItem("basePrice"));
          if (isFinite(bp)) try{ showToast("å·²åŒæ­¥åº•åƒ¹åˆ°é›²ç«¯"); }catch(e){}
        };
      });
    })();
  </script>

</body>
</html>
