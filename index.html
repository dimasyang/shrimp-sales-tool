<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ¦ è¦ä»æˆæœ¬å ±åƒ¹è©¦ç®—è¡¨</title>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--bd:#ddd;--muted:#666;--brand:#4f8cff;--brand2:#7aa2ff;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;color:#222}
    .container{max-width:1000px;margin:0 auto;padding:16px 16px 100px}
    h1{margin:0 0 8px} .lead{color:var(--muted);margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    label span{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button,a.btn{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    .btn{cursor:pointer;background:#f3f4f6;text-align:center;text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#fff;border:none;font-weight:600}
    .btn.ok{background:#e8f7ee;border-color:#c6f1d8;color:#146c43}
    .btn.danger{background:#fde2e2;border-color:#f5c2c7;color:#842029}
    .actions{display:grid;gap:10px;grid-template-columns:1fr 1fr} @media(min-width:640px){.actions{grid-template-columns:repeat(4,1fr)}}
    .result{margin-top:10px;background:#fff;border:1px solid var(--bd);border-radius:8px;padding:12px}
    .result .em{color:#b00020;font-weight:700}
    .dock{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-top:1px solid var(--bd);padding:10px;display:grid;gap:10px;grid-template-columns:1fr 1fr} 
    @media(min-width:640px){.dock{grid-template-columns:repeat(4,1fr)}}
    /* toast */
    .toast-wrap{position:fixed;right:12px;bottom:12px;z-index:9999;display:grid;gap:8px;max-width:80vw}
    .toast{background:rgba(0,0,0,.82);color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);font-size:14px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¦ è¦ä»æˆæœ¬å ±åƒ¹è©¦ç®—è¡¨</h1>
    <p class="lead">æ‰‹æ©Ÿå‹å–„ï½œè¨ˆç®—æˆæœ¬èˆ‡åº•åƒ¹ï¼ˆå­˜åˆ° Firestoreï¼Œçé‡‘é æœƒè‡ªå‹•å¸¶å…¥ï¼‰</p>
    <section class="card">
      <div class="grid">
        <label><span>åŸæ–™é‡é‡ (kg)</span><input type="number" id="rawWeight" value="16" /></label>
        <label><span>åŸæ–™å–®åƒ¹ (å…ƒ/kg)</span><input type="number" id="rawPrice" value="420" /></label>
        <label><span>ç™¼æ³¡ç‡ (%)</span><input type="number" id="foamRate" value="25" /></label>
        <label><span>åŒ…å†°ç‡ (%)</span><input type="number" id="iceRate" value="20" /></label>
        <label><input type="checkbox" id="cut" /> æ˜¯å¦å‰²èƒŒï¼ˆæ¯å…¬æ–¤ +13 å…ƒï¼‰</label>
        <label style="grid-column:1 / -1;">
          <input type="radio" name="foamType" id="outsourceFoam" checked /> å§”å¤–ç™¼æ³¡ï¼ˆæ¯å…¬æ–¤ +15 å…ƒï¼‰
          &nbsp; <input type="radio" name="foamType" id="selfFoam" /> è‡ªè¡Œç™¼æ³¡ï¼ˆæ¯å…¬æ–¤ +12 å…ƒï¼‰
        </label>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnCalc">è¨ˆç®—</button>
        <a class="btn" id="btnToBonus" href="./bonus.html">å‰å¾€çé‡‘é </a>
        <button class="btn ok" id="btnCopyBase">è¤‡è£½åº•åƒ¹</button>
        <button class="btn danger" id="btnReset">æ¸…ç©º</button>
      </div>
      <div id="results" class="result" aria-live="polite"></div>
    </section>
  </div>
  <nav class="dock">
    <button class="btn primary" id="dockCalc">è¨ˆç®—</button>
    <a class="btn" id="dockToBonus" href="./bonus.html">çé‡‘é </a>
    <button class="btn ok" id="dockCopyBase">è¤‡è£½åº•åƒ¹</button>
    <button class="btn danger" id="dockReset">æ¸…ç©º</button>
  </nav>

  <div id="toast-wrap" class="toast-wrap" hidden></div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script>
    // å°ˆæ¡ˆè¨­å®šï¼ˆsales-bonusrecordï¼‰
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyBw4SbJMjNxoj6P9Zwi4SAlSIi30A8uAp4",
      authDomain: "sales-bonusrecord.firebaseapp.com",
      projectId: "sales-bonusrecord",
      storageBucket: "sales-bonusrecord.firebasestorage.app",
      messagingSenderId: "679798751240",
      appId: "1:679798751240:web:0ed7b227af33e0122fd1bd",
      measurementId: "G-WFSZG479WS"
    };
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    const db = firebase.firestore();
    try { db.enablePersistence({synchronizeTabs:true}); } catch(e){ console.warn(e); }
    firebase.auth().signInAnonymously().catch(console.warn);
    const PROFILE_ID = localStorage.getItem('profileId') || 'default';

    function toast(msg, ms=2200){
      const wrap = document.getElementById('toast-wrap');
      wrap.hidden=false;
      const t = document.createElement('div');
      t.className='toast'; t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .25s'; setTimeout(()=>t.remove(), 300); }, ms);
    }

    function calculate() {
      const rawWeight = parseFloat(document.getElementById("rawWeight").value || 0);
      const rawPrice = parseFloat(document.getElementById("rawPrice").value || 0);
      const foamRate = parseFloat(document.getElementById("foamRate").value || 0) / 100;
      const iceRate = parseFloat(document.getElementById("iceRate").value || 0) / 100;
      const cut = document.getElementById("cut").checked;
      const isOutsource = document.getElementById("outsourceFoam").checked;

      const cutCost = cut ? rawWeight * 13 : 0;
      const foamWeight = rawWeight * (1 + foamRate);
      const foamCost = isOutsource ? foamWeight * 15 : foamWeight * 12;
      const iceWeight = foamWeight / (1 - iceRate);
      const iceCost = iceWeight * 18;
      const rawCost = rawWeight * rawPrice;

      const totalCost = rawCost + cutCost + foamCost + iceCost;
      const costPerKg = iceWeight > 0 ? (totalCost / iceWeight) : 0;
      const basePrice = costPerKg / 0.85;
      const suggestedPrice = costPerKg / 0.75;

      localStorage.setItem("basePrice", basePrice.toFixed(2));
      // åŒæ­¥åˆ° Firestoreï¼ˆsettings/baseï¼‰
      db.collection("profiles").doc(PROFILE_ID).collection("settings").doc("base")
        .set({ basePrice: Number(basePrice.toFixed(2)), updatedAt: Date.now() }, { merge:true })
        .then(()=> toast("å·²åŒæ­¥åº•åƒ¹åˆ°é›²ç«¯"))
        .catch(console.warn);

      // æ›´æ–°ã€Œå‰å¾€çé‡‘é ã€é€£çµå¸¶ ?bp=
      const rounded = Math.round(basePrice);
      ["btnToBonus","dockToBonus"].forEach(id=>{
        const a=document.getElementById(id); if(a) a.href="./bonus.html?bp="+rounded;
      });

      document.getElementById("results").innerHTML = `
        <p>ç¸½æˆæœ¬ï¼š<span class="em">${totalCost.toFixed(0)}</span> å…ƒ</p>
        <p>æˆå“é‡é‡ï¼š<span class="em">${iceWeight.toFixed(2)}</span> å…¬æ–¤</p>
        <p>æ¯å…¬æ–¤æˆæœ¬ï¼š<span class="em">${costPerKg.toFixed(0)}</span> å…ƒ</p>
        <p>åº•åƒ¹ï¼ˆæ¯›åˆ©15%ï¼‰ï¼š<span class="em" id="basePriceText">${basePrice.toFixed(0)}</span> å…ƒ</p>
        <p>å»ºè­°å”®åƒ¹ï¼ˆæ¯›åˆ©25%ï¼‰ï¼š<span class="em">${suggestedPrice.toFixed(0)}</span> å…ƒ</p>
      `;
    }

    function copyBase(){
      const bp = document.getElementById("basePriceText")?.innerText || localStorage.getItem("basePrice") || "";
      if(!bp){ alert("è«‹å…ˆè¨ˆç®—ä¸€æ¬¡åº•åƒ¹"); return; }
      navigator.clipboard.writeText(bp).then(()=> toast("å·²è¤‡è£½åº•åƒ¹ï¼š"+bp));
    }
    function resetForm(){
      ["rawWeight","rawPrice","foamRate","iceRate"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("cut").checked = false;
      document.getElementById("outsourceFoam").checked = true;
      document.getElementById("selfFoam").checked = false;
      document.getElementById("results").innerHTML = "";
      localStorage.removeItem("basePrice");
    }

    // è¼‰å…¥æ™‚è£œä¸Šé€£çµçš„ ?bp
    document.addEventListener("DOMContentLoaded", async ()=>{
      try{
        let bp = localStorage.getItem("basePrice");
        if (!bp || isNaN(parseFloat(bp))) {
          const snap = await db.collection("profiles").doc(PROFILE_ID).collection("settings").doc("base").get();
          const data = snap.exists ? snap.data() : null;
          if (data && isFinite(data.basePrice)) {
            bp = String(data.basePrice);
            localStorage.setItem("basePrice", bp);
            toast("å·²å¾é›²ç«¯è¼‰å…¥åº•åƒ¹ï¼š" + Math.round(parseFloat(bp)) + " å…ƒ");
          }
        }
        const rounded = bp && !isNaN(parseFloat(bp)) ? Math.round(parseFloat(bp)) : null;
        ["btnToBonus","dockToBonus"].forEach(id=>{
          const el=document.getElementById(id); if(el) el.href = rounded ? "./bonus.html?bp="+rounded : "./bonus.html";
        });
      }catch(e){ console.warn(e); }
    });

    ["btnCalc","dockCalc"].forEach(id=> document.getElementById(id).onclick = calculate);
    ["btnCopyBase","dockCopyBase"].forEach(id=> document.getElementById(id).onclick = copyBase);
    ["btnReset","dockReset"].forEach(id=> document.getElementById(id).onclick = resetForm);
  </script>
</body>
</html>
